<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.115.1">
<link rel="canonical" type="text/html" href="https://x-windy.github.io/blog/">
<link rel="alternate" type="application/rss&#43;xml" href="https://x-windy.github.io/blog/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>博客 | x-windy</title>
<meta name="description" content="A Docsy example site">
<meta property="og:title" content="博客" />
<meta property="og:description" content="A Docsy example site" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://x-windy.github.io/blog/" />
<meta itemprop="name" content="博客">
<meta itemprop="description" content="A Docsy example site"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="博客"/>
<meta name="twitter:description" content="A Docsy example site"/>




<link rel="preload" href="/scss/main.min.6176d7d472a139a502a7c863de9bb7b87ef1ec9c271ff8f3d8ba4d983491b9ac.css" as="style">
<link href="/scss/main.min.6176d7d472a139a502a7c863de9bb7b87ef1ec9c271ff8f3d8ba4d983491b9ac.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-00000000-0"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'UA-00000000-0');
}
</script>
  </head>
  <body class="td-section td-blog">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">x-windy</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/blog/"><span>博客</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/docs/"><span>文档</span></a>
      </li>
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/en/blog/">English</a></li>
    <li><a class="dropdown-item" href="/ja/blog/">日本語</a></li>
    </ul>
</div></li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search">
  <div class="td-search__icon"></div>
  <input type="search" class="td-search__input form-control td-search-input" placeholder="站内搜索…" aria-label="站内搜索…" autocomplete="off">
</div>

  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/blog/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">博客</h1>





    <ul>
    
  
  
  
  

  
    
    
	

    <li><a href="#pg-d594774483c85d71ff3035fc526a4650">Java</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-56e9ef72b11f59a2900fa303cdbeb59d"></a></li>



    
  
    
    
	

    <li><a href="#pg-41c0b0c1bf0ec7e293777a805b410293"></a></li>



    
  
    
    
	

    <li><a href="#pg-0106f5d1f87398d63e0cd20c3a0efd16">JWT</a></li>



    
  
    
    
	

    <li><a href="#pg-afd7f7b25840af8cd0e8d313baea0879">RESTful</a></li>



    
  
    
    
	

    <li><a href="#pg-ab3aaaa7b66c7c4bce279dd87d4ef870">ruoyi</a></li>



    
  
    
    
	

    <li><a href="#pg-ce94205a00302c2292e49c3c5d0504d5">SpringSecurity</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-090ecc4ee4f7bd35e66c63755fc21a6e">Python</a></li>



    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	

    <li><a href="#pg-5d8451038365f46f4fe243927b4a9b97">Spring boot</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-ec51f207d35e5d80d77970dfc922522f">SSM</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-f97d01fae70ecdf16778c685395fa9b1">日语</a></li>



    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	

    <li><a href="#pg-bee76132ef4ff470b1e270563493766f">Spring Cloud</a></li>



    
  
    
    
	

    <li><a href="#pg-dc25dce949429781efd35f25490c266c">Docker</a></li>



    
  
    
    
	

    <li><a href="#pg-74077482854f1f5386479a36e54652ad">Hugo</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-62ba6622c15ab3327cd760e146b1eb0a">准备</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-be19b65969eca584d90beb10964cea5d">Redis</a></li>



    
  

    </ul>


<div class="content">
      <p>This is the <strong>blog</strong> section. It has two categories: News and Releases.</p>
<p>Files in these directories will be listed in reverse chronological order.</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-d594774483c85d71ff3035fc526a4650">Java</h1>
	
	<div class="td-byline mb-4">
		
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-56e9ef72b11f59a2900fa303cdbeb59d"></h1>
	
	<div class="td-byline mb-4">
		
        
	</div>
	<h1 id="java">Java</h1>
<ol>
<li>JavaSE</li>
<li>JavaEE</li>
<li>SSM</li>
<li>Spring Boot</li>
<li>Spring Cloud</li>
</ol>
<h2 id="javase">JavaSE</h2>
<blockquote>
<p>Java标准版(Java Standard Edition)</p>
<p>使用于桌面应用程序和小型服务器应用程序的Java平台</p>
<p>是Java技术的核心和基础，包含了Java语言核心库、Java虚拟机（JVM）和Java开发工具包（JDK）</p>
</blockquote>
<ol>
<li>开发环境搭建(JDK安装、集成开发环境IDEA使用)</li>
<li>Java基础</li>
<li>Java进阶</li>
<li>数据结构和算法</li>
</ol>
<h3 id="面向对象oop">面向对象(OOP)</h3>
<h3 id="反射机制reflection">反射机制(Reflection)</h3>
<h3 id="注解annotation">注解(Annotation)</h3>
<h3 id="异常exception">异常(Exception)</h3>
<h2 id="javaee">JavaEE</h2>
<blockquote>
<p>Java企业版(Java Enterprise Edition)</p>
<p>使用于企业级应用程序开发的Java平台</p>
<p>JavaEE扩展了JavaSE，包含<code>Java Servlet、JavaServer Pages（JSP）、Java Messaging Service（JMS）、Java Persistence API（JPA）</code>等</p>
<p>JavaEE还提供了企业级容器，如<strong>Web容器</strong>等</p>
</blockquote>
<h3 id="web项目">Web项目</h3>
<p><strong>Web项目结构：</strong></p>
<p><code>src</code>：存放Java代码</p>
<p><code>web</code>：存放静态资源(html、css、js)和jsp</p>
<p><code>WEB-INF</code>：不能够被浏览器直接访问</p>
<p><code>WEB-INF/lib</code>：存放jar包</p>
<p><code>WEB-INF/web.xml</code>：web项目的核心配置文件</p>
<p><strong>三层开发结构：</strong></p>
<p><code>dao/mapper</code>：<strong>数据访问层</strong>，增删改查，**不涉及业务逻辑，只是达到按某个条件获得指定数据的要求。**向数据库发送SQL语句</p>
<p>`entity：实体类(Java对象)</p>
<p><code>service</code>：处理业务逻辑，<strong>需要先写一个接口(接口声明抽象方法)，然后再去实现(实现类实现具体方法)</strong></p>
<p><code>servlet/controller</code>：负责请求响应的控制</p>
<h4 id="tomcat">Tomcat</h4>
<p><strong>Tomcat的文件目录：</strong></p>
<p><code>bin</code>：可执行文件</p>
<p><code>conf</code>：配置文件</p>
<p><code>lib</code>：tomcat依赖的包</p>
<p><code>logs</code>：日志文件</p>
<p><code>temp</code>：临时文件</p>
<p><code>webapps</code>：存放web项目的地方</p>
<p><code>work</code>：运行时的数据</p>
<h5 id="servlet">Servlet</h5>
<h5 id="jsp">Jsp</h5>
<h5 id="el表达式">EL表达式</h5>
<h5 id="jstl标签库">Jstl标签库</h5>
<h2 id="ssm">SSM</h2>
<blockquote>
<p>Spring+SpringMVC+MyBatis</p>
</blockquote>
<h2 id="spring-boot">Spring Boot</h2>
<p><code>src/main/java/</code>结构</p>
<blockquote>
<p>存放项目Java源代码</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>|_annotation：放置项目自定义注解
</span></span><span style="display:flex;"><span>|_aspect：放置切面代码
</span></span><span style="display:flex;"><span>|_config：放置配置类
</span></span><span style="display:flex;"><span>|_constant：放置常量、枚举等定义
</span></span><span style="display:flex;"><span>   |__consist：存放常量定义
</span></span><span style="display:flex;"><span>   |__enums：存放枚举定义
</span></span><span style="display:flex;"><span>|_controller：放置控制器代码
</span></span><span style="display:flex;"><span>|_filter：放置一些过滤、拦截相关的代码
</span></span><span style="display:flex;"><span>|_mapper：放置数据访问层代码接口
</span></span><span style="display:flex;"><span>|_model：放置数据模型代码
</span></span><span style="display:flex;"><span>   |__entity：放置数据库实体对象定义
</span></span><span style="display:flex;"><span>   |__dto：存放数据传输对象定义
</span></span><span style="display:flex;"><span>   |__vo：存放显示层对象定义
</span></span><span style="display:flex;"><span>|_service：放置具体的业务逻辑代码（接口和实现分离）
</span></span><span style="display:flex;"><span>   |__intf：存放业务逻辑接口定义
</span></span><span style="display:flex;"><span>   |__impl：存放业务逻辑实际实现
</span></span><span style="display:flex;"><span>|_utils：放置工具类和辅助代码
</span></span></code></pre></div><p><code>/src/main/resources</code>结构</p>
<blockquote>
<p>放静态配置文件和页面静态资源等东西</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>|_mapper：存放mybatis的XML映射文件（如果是mybatis项目）
</span></span><span style="display:flex;"><span>|_static：存放网页静态资源，比如下面的js/css/img
</span></span><span style="display:flex;"><span>   |__js：
</span></span><span style="display:flex;"><span>   |__css：
</span></span><span style="display:flex;"><span>   |__img：
</span></span><span style="display:flex;"><span>   |__font：
</span></span><span style="display:flex;"><span>   |__等等
</span></span><span style="display:flex;"><span>|_template：存放网页模板，比如thymeleaf/freemarker模板等
</span></span><span style="display:flex;"><span>   |__header
</span></span><span style="display:flex;"><span>   |__sidebar
</span></span><span style="display:flex;"><span>   |__bottom
</span></span><span style="display:flex;"><span>   |__XXX.html等等
</span></span><span style="display:flex;"><span>|_application.yml       基本配置文件
</span></span><span style="display:flex;"><span>|_application-dev.yml   开发环境配置文件
</span></span><span style="display:flex;"><span>|_application-test.yml  测试环境配置文件
</span></span><span style="display:flex;"><span>|_application-prod.yml  生产环境配置文件
</span></span></code></pre></div><p><code>DTO/VO/DO</code>等<strong>数据模型定义</strong>的区分：</p>
<ul>
<li>
<p><code>DO（Data Object）</code>：与数据库表结构一一对应，通过DAO层向上传输数据源对象。<strong>服务层与DAO层之间数据传输的对象</strong></p>
</li>
<li>
<p><code>DTO（Data Transfer Object）</code>：数据传输对象，Service或Manager向外传输的对象。<strong>控制层与服务层之间数据传输的对象</strong></p>
</li>
<li>
<p><code>BO（Business Object）</code>：业务对象。由Service层输出的封装业务逻辑的对象。</p>
</li>
<li>
<p><code>AO（Application Object）</code>：应用对象。在Web层与Service层之间抽象的复用对象模型，极为贴近展示层，复用度不高。</p>
</li>
<li>
<p><code>VO（View Object）</code>：显示层对象，通常是Web向模板渲染引擎层传输的对象。</p>
</li>
<li>
<p><code>Query</code>：数据查询对象，各层接收上层的查询请求。注意超过2个参数的查询封装，禁止使用Map类来传输。</p>
<p>注意事项：</p>
<p>1、<code>Contorller</code>层参数传递建议不要使用<code>HashMap</code>，建议使用<strong>数据模型</strong>定义</p>
<p>2、<code>Controller</code>层里可以做<strong>参数校验、异常抛出</strong>等操作，但建议不要放太多业务逻辑，业务逻辑尽量放到<code>Service</code>层代码中去做</p>
<p>3、<code>Service</code>层做实际业务逻辑，可以按照功能模块做好定义和区分，相互可以调用</p>
<p>4、功能模块<code>Service</code>之间引用时，建议不要渗透到<code>DAO</code>层（或者<code>mapper</code>层），基于<code>Service</code>层进行调用和复用比较合理</p>
<p>5、业务逻辑层<code>Service</code>和数据库<code>DAO</code>层的操作对象不要混用。<code>Controller</code>层的数据对象不要直接渗透到<code>DAO</code>层（或者<code>mapper</code>层）；同理数据表实体对象<code>Entity</code>也不要直接传到<code>Controller</code>层进行输出或展示。</p>
</li>
</ul>
<h2 id="spring-cloud">Spring Cloud</h2>
<h2 id="其它">其它</h2>
<h3 id="javame">JavaME</h3>
<blockquote>
<p>Java Micro Edition</p>
<p>用于嵌入式设备和移动设备上的Java平台</p>
<p>包括了Java虚拟机和一系列的API，如<code>Java ME Connected Limited Device Configuration（CLDC）、Mobile Information Device Profile（MIDP）</code>等。</p>
<p>JavaME支持多种移动设备，如智能手机、平板电脑、数字电视等。</p>
</blockquote>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-41c0b0c1bf0ec7e293777a805b410293"></h1>
	
	<div class="td-byline mb-4">
		
        
	</div>
	<h1 id="lombok">Lombok</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-XML" data-lang="XML"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.projectlombok<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>lombok<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h2 id="注解">注解</h2>
<h3 id="data">@Data</h3>
<h3 id="accessors">@Accessors</h3>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-0106f5d1f87398d63e0cd20c3a0efd16">JWT</h1>
	
	<div class="td-byline mb-4">
		作者: <b>XW</b> |
        
	</div>
	<h1 id="jwtjson-web-token">JWT(JSON Web Token)</h1>
<blockquote>
<p><a href="https://jwt.io/">JSON Web Tokens - jwt.io</a></p>
<p>JWT是一种<strong>加密后的数据载体</strong>，可在各应用之间进行数据传输</p>
<p>Token(令牌)</p>
<p><strong>Token的目的是为了减轻服务器的压力，减少频繁的查询数据库，使服务器更加健壮。</strong></p>
</blockquote>
<h2 id="什么是-json-web-token">什么是 JSON Web Token？</h2>
<p>JSON Web Token（JWT） 是一种开放标准 （<a href="https://tools.ietf.org/html/rfc7519">RFC 7519</a>），它定义了一种紧凑且独立的方式，用于在各方之间以 <strong>JSON 对象</strong>的形式<strong>安全地</strong>传输信息。此信息可以验证和信任，因为它是经过<strong>数字签名</strong>的。JWT 可以使用密钥（使用 <strong>HMAC</strong> 算法）或使用 <strong>RSA</strong> 或 <strong>ECDSA</strong> 的公钥/私钥对进行签名。</p>
<blockquote>
<p>JWT涵盖用户身份信息，每次访问时，服务器校验信息合法性</p>
</blockquote>
<h2 id="何时应使用-json-web-token">何时应使用 JSON Web Token？</h2>
<p>以下是 JSON Web Token有用的一些方案：</p>
<ul>
<li><strong>授权</strong>：这是使用 JWT 的最常见方案。<strong>用户登录</strong>后，每个后续请求都将包含 JWT，允许用户访问使用该令牌允许的路由、服务和资源。单点登录是当今广泛使用 JWT 的一项功能，因为它的开销很小，并且能够跨不同域轻松使用。</li>
<li><strong>信息交换</strong>： JSON Web Token是在各方之间安全传输信息的好方法。由于 JWT 可以签名（例如，使用公钥/私钥对），因此您可以确定发件人是他们所说的人。此外，由于签名是使用标头和有效负载计算的，因此您还可以验证内容是否未被篡改。</li>
</ul>
<h2 id="json-web-token结构">JSON Web Token结构</h2>
<blockquote>
<p>一个JWT通常有HEADER(头)，PAYLOAD(有效载荷)和SIGNATURE(签名)三部分组成，之间通过<code>.</code>连接</p>
</blockquote>
<ul>
<li>Header	头(算法和令牌类型)</li>
<li>Payload   有效载荷(数据)</li>
<li>Signature 签名</li>
</ul>
<pre tabindex="0"><code>Header.Payload.Signature
xxxxx.yyyyy.zzzzz
</code></pre><p><strong>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9<code>.</code>eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ<code>.</code>SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</strong></p>
<h3 id="header-头">Header 头</h3>
<p>JWT的头部包含两部分的信息：</p>
<blockquote>
<ol>
<li>令牌的类型（即 <code>JWT</code>）</li>
<li>使用的加密算法，例如 <code>HMAC SHA256</code> (默认<code>HS256</code>)或 <code>RSA</code>。</li>
</ol>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;alg&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;HS256&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;typ&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;JWT&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>alg</code>：表示签名的算法</p>
<p><code>typ</code>：标识令牌(token)的类型，JWT令牌统一写为<code>JWT</code></p>
<p>使用<code>Base64</code>加密后，构成JWT的第一部分<code>Header</code></p>
<pre tabindex="0"><code></code></pre><h3 id="payload-有效载荷">Payload 有效载荷</h3>
<blockquote>
<p>用于存放实际需要传递的有效信息</p>
</blockquote>
<p><strong>标准载荷</strong>：建议但不强制使用，对JWT信息作补充</p>
<table>
<thead>
<tr>
<th>标准载荷</th>
<th>介绍</th>
</tr>
</thead>
<tbody>
<tr>
<td>iss(issuer)</td>
<td>jwt签发者</td>
</tr>
<tr>
<td>exp(expiration time)</td>
<td>过期时间，必须大于签发时间</td>
</tr>
<tr>
<td>sub(subject)</td>
<td>主题，用来做什么</td>
</tr>
<tr>
<td>aud(audience)</td>
<td>给谁用，接收jwt的一方</td>
</tr>
<tr>
<td>nbf(Not Before)</td>
<td>生效时间</td>
</tr>
<tr>
<td>jti(JWT ID)</td>
<td>JWT的唯一身份标识</td>
</tr>
</tbody>
</table>
<p>自定义载荷：一般添加用户的相关信息 或 其它业务需要的必要信息，不建议添加<strong>敏感信息</strong>(如用户密码)，该部分可在客户端解密</p>
<p><strong>受篡改保护，但任何人都可以读取</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;sub&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;alluser&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;iss&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;zq&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;user_info&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    	<span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    	<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;John Doe&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>使用Base64加密后，构成JWT第二部分</p>
<pre tabindex="0"><code></code></pre><h3 id="signature-签名">Signature 签名</h3>
<blockquote>
<p>对<strong>前两部分Header、Payload进行签名</strong>，得到一个签名，防止数据篡改</p>
<p>需要指定一个<strong>密钥(secret)</strong>-256-bit，密钥只有服务器知道。(不能泄露)</p>
</blockquote>
<p>使用Header指定的 HMAC SHA256 算法签名：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">signature</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">HMACSHA256</span><span style="color:#ce5c00;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">base64UrlEncode</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">header</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;.&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">base64UrlEncode</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">payload</span><span style="color:#ce5c00;font-weight:bold">),</span><span style="color:#000">secret</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>使用Base64加密后，构成JWT的第三部分</p>
<h2 id="jwt-token在线编码生成httpstoolttcomjwt-encode"><a href="https://tooltt.com/jwt-encode/">JWT Token在线编码生成</a></h2>
<h3 id="完整json">完整JSON</h3>
<pre tabindex="0"><code>{
  &#34;header&#34;: {
    &#34;alg&#34;: &#34;HS256&#34;,
    &#34;typ&#34;: &#34;JWT&#34;
  },
  &#34;payload&#34;: {
    &#34;data&#34;: [
      {
        &#34;id&#34;: &#34;1&#34;
      },
      {
        &#34;name&#34;: &#34;zq&#34;
      },
      {
        &#34;age&#34;: &#34;20&#34;
      }
    ],
    &#34;iat&#34;: 1690988484,
    &#34;exp&#34;: 1691078398,
    &#34;aud&#34;: &#34;qz&#34;,
    &#34;iss&#34;: &#34;zq&#34;,
    &#34;sub&#34;: &#34;all&#34;
  }
}
</code></pre><h3 id="jwt">JWT</h3>
<pre tabindex="0"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjpbeyJpZCI6IjEifSx7Im5hbWUiOiJ6cSJ9LHsiYWdlIjoiMjAifV0sImlhdCI6MTY5MDk4ODQ4NCwiZXhwIjoxNjkxMDc4Mzk4LCJhdWQiOiJxeiIsImlzcyI6InpxIiwic3ViIjoiYWxsIn0.abOPHo6ytyaCglKfXgiDPQkcFDdM90FpgX20ktvpBf4
</code></pre><h2 id="jwt特点">JWT特点</h2>
<h3 id="无状态">无状态</h3>
<p>JWT不需要再服务端存取任何状态，客户端而已携带JWT访问服务端，从而使服务端变得无状态，这样，服务端就可以轻松地实现<strong>扩展和负载均衡</strong>。(分布式多台服务器)，只需要校验，不需要存储</p>
<h3 id="可自定义">可自定义</h3>
<p>JWT的有效载荷部分可以自定义，可以存储任何JSON格式的数据。可实现自定义的功能，如用户喜好、配置信息等等。</p>
<h3 id="扩展性强">扩展性强</h3>
<p>JWT有一套标准规范，很容易再不同平台和语言之间共享和解析。开发人员还可以根据需要自定义声明(claims)来实现更加灵活的功能。</p>
<h3 id="调试性好">调试性好</h3>
<p>JWT内容以Base64编码后的字符串形式存在，非常容易进行调试和分析。</p>
<h3 id="安全性取决于密钥管理">安全性取决于密钥管理</h3>
<p>注意密钥的管理，包含生成、存储、更新、分发等等。</p>
<h3 id="无法撤销">无法撤销</h3>
<p>JWT是无状态的，一旦JWT被签发，就无法撤销(除非过期)。如果用户在使用JWT认证期间被注销或禁用，那么服务端就无法阻止该用户继续使用之前签发的JWT。</p>
<p>因此，开发人员需要设计额外的机制来<strong>撤销JWT</strong>，例如使用黑名单、白名单、<strong>加到缓存Redis</strong>(无状态-&gt;有状态) 或者 设置 短期有效期等</p>
<h3 id="需要缓存到客户端">需要缓存到客户端</h3>
<p>JWT包含用户信息和授权信息，需要客户端缓存到本地，意味着JWT有被窃取的风险</p>
<h3 id="载荷大小由限制">载荷大小由限制</h3>
<p>JWT需要传输到客户端，一般不建议超过<strong>1KB</strong>(10个kv对以内)，不然会影响性能</p>
<h2 id="jwt的优缺点">JWT的优缺点</h2>
<h3 id="优点">优点</h3>
<p>无状态性：不需要存储在服务器上，可以实现无状态的身份验证和授权(分布式)</p>
<p>可扩展性：载荷可自定义，可根据需要添加任意信息</p>
<p>可靠性：使用数字签名来保证安全性</p>
<p>平台性：支持多编程语言和操作系统</p>
<p>高效性：不需要查数据库</p>
<h3 id="缺点">缺点</h3>
<p>安全性取决于密钥管理</p>
<p>无法撤销令牌</p>
<p>需要传输到客户端</p>
<p>载荷大小限制</p>
<h2 id="jwt应用场景">JWT应用场景</h2>
<h3 id="一次性验证">一次性验证</h3>
<p>应用场景</p>
<blockquote>
<p>用户注册成功后，发送一份激活邮箱或者其它业务需要邮箱激活等操作。</p>
<p>用户注册账户（填写用户名、密码、邮箱）后，会发送一封邮件给用户的邮箱。邮件里面有个链接，用户点击后，邮箱就被验证了。用户如果没有进行验证的话，是不允许一些操作的，如发表文章（防止恶意注册用户）。</p>
</blockquote>
<p>原因：</p>
<p>时效性：让该链接具有时效性(2小时内激活)</p>
<p>不可篡改性：防止篡改以激活其它账户</p>
<p>邮箱注册</p>
<p><img src="jwt.assets/bV855x.png" alt="后端开发 - 用户邮箱验证实现思路 - 个人文章 - SegmentFault 思否"></p>
<h3 id="restful-api的无状态认证">RESTful API的无状态认证</h3>
<p>做RESTful api的身份凭证：当用户身份校验成功后，客户端每次接口访问都带上JWT，服务端校验JWT合法性(是否篡改/是否过期等)</p>
<h3 id="信息交换">信息交换</h3>
<p>项目间/服务间 之间安全传输信息的好方式，使用公钥（Public Key）与私钥（Private Key），可以确定发件人是他们自称的人。</p>
<blockquote>
<p>公钥（Public Key）与私钥（<a href="https://so.csdn.net/so/search?q=Private&amp;spm=1001.2101.3001.7020">Private</a> Key）是通过一种算法得到的一个密钥对（即一个公钥和一个私钥），<strong>公钥</strong>是密钥对中<strong>公开的部分</strong>，<strong>私钥</strong>则是<strong>非公开的部分</strong>。公钥通常用于<strong>加密会话密钥、验证数字签名，或加密可以用相应的私钥解密</strong>的数据。</p>
<p>公钥和私钥是成对出现的，我们会保留有自己的私钥，同时公开自己的公钥。一个很典型的例子是GitHub的使用。我们通常不会使用账号密码来管理自己的项目，而是通过将自己的<strong>公钥</strong>上传到GitHub的里，而自己的电脑里则保留有相对应的<strong>私钥</strong>，从而达到免密码提交代码。</p>
<p>当然私钥和公钥对是唯一的，而你也可以随时重新生成自己的公钥和私钥密码对，但当你从新生成密钥对并覆盖了就有的密钥时，你之前的公钥就作废了。</p>
<p>简单来说就是：
公钥加密，私钥解密，
私钥签名，公钥验证。</p>
<p><a href="https://blog.csdn.net/u010039377/article/details/79751124">公钥私钥加密和SHA256_sha256密钥_卖鱼的小白菜的博客-CSDN博客</a></p>
</blockquote>
<h3 id="jwt令牌登录">JWT令牌登录</h3>
<blockquote>
<p>JWT令牌存储在客户端，容易泄露并被伪造身份搞破环</p>
<p>JWT被签发，就无法撤销，当破坏在进行时，后端无法马上禁止</p>
</blockquote>
<p>可以通过监控异常JWT访问，设置黑名单+强制下线等方式避免</p>
<h2 id="jwt实战案例">JWT实战案例</h2>
<h3 id="jwt工具类">JWT工具类</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">com.zq.vaccinum.util</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">com.zq.vaccinum.constant.Constants</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">io.jsonwebtoken.Claims</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">io.jsonwebtoken.Jwts</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">io.jsonwebtoken.io.Decoders</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">io.jsonwebtoken.security.Keys</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">java.util.Date</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">java.util.Map</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * JwtToken工具类
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @Author: zq
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @Date: 2023/08/03/0:51
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @Description:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">JwtTokenUtil</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 生成token令牌
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param claims 数据声明(载荷信息)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return  token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">String</span> <span style="color:#000">createToken</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Map</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">Object</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">claims</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">String</span> <span style="color:#000">token</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Jwts</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">builder</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// 使用默认头
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setClaims</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">claims</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 存放自定义载荷
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setExpiration</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">getExpirationDate</span><span style="color:#ce5c00;font-weight:bold">())</span> <span style="color:#8f5902;font-style:italic">// 失效时间
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">signWith</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Keys</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hmacShaKeyFor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Decoders</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">BASE64</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">decode</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Constants</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">JWT_SECRET</span><span style="color:#ce5c00;font-weight:bold">)))</span> <span style="color:#8f5902;font-style:italic">// 签名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">compact</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">token</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 解析token中的数据声明(载荷信息)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param token 令牌
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return  数据声明
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">Claims</span> <span style="color:#000">parseToken</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">token</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Jwts</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">parserBuilder</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setSigningKey</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Decoders</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">BASE64</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">decode</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Constants</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">JWT_SECRET</span><span style="color:#ce5c00;font-weight:bold">))</span>    <span style="color:#8f5902;font-style:italic">// 签名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">parseClaimsJws</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">token</span><span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">// 接收的token令牌
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getBody</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 生成Token失效截至时间
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">Date</span> <span style="color:#000">getExpirationDate</span><span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 当前系统时间+失效时间
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Date</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">currentTimeMillis</span><span style="color:#ce5c00;font-weight:bold">()+</span> <span style="color:#000">Constants</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">JWT_EXPIRATION</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 从Token获取用户名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">String</span> <span style="color:#000">getUsernameFromToken</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">token</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// parseToken()解析Token获取claims
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">parseToken</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">token</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">getSubject</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 判断token是否失效
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">isTokenExpired</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">token</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 判断当前时间是否在时效截止时间内(截止时间是否在当前时间之前)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">getExpirationDate</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">before</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Date</span><span style="color:#ce5c00;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 验证token是否有效(是否修改null,是否过期)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">validateToken</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">token</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">parseToken</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">token</span><span style="color:#ce5c00;font-weight:bold">)!=</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span><span style="color:#000">isTokenExpired</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">token</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 刷新token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">String</span> <span style="color:#000">refreshToken</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">token</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 解析token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">Claims</span> <span style="color:#000">claims</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">parseToken</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">token</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 重置创建时间
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">claims</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Constants</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">JWT_CREATE_TIME</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Date</span><span style="color:#ce5c00;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 生成新的token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">createToken</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">claims</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 从载体信息中根据key拿值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param claims  载体信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param key  键
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return  值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">String</span> <span style="color:#000">getValueByKey</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Claims</span> <span style="color:#000">claims</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">String</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">claims</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">)!=</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000">claims</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">toString</span><span style="color:#ce5c00;font-weight:bold">():</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="邮件激活">邮件激活</h3>
<ol>
<li>
<p>/regist注册接口，请求成功后，发送激活链接，链接参数为jwt</p>
</li>
<li>
<p>/active?jwt=激活，接收参数为jwt</p>
</li>
</ol>
<p><a href="https://jwt.io/libraries?language=Java">JSON Web Token Libraries - jwt.io</a></p>
<h3 id="令牌登录">令牌登录</h3>
<ol>
<li>/login登录成功后，返回JWT给客户端</li>
<li>设计<strong>登录检查拦截器</strong>，当访问<strong>其它接口资源</strong>时进行登录拦截</li>
</ol>
<h2 id="jwt指南">JWT指南</h2>
<h3 id="redis校验实现令牌泄露保护">Redis校验实现令牌泄露保护</h3>
<p>在<strong>Redis缓存一份</strong>，判定泄露后(每次进行)，移除Redis中的JWT，当接口再次被发起请求时，强制用户重新进行身份验证</p>
<h3 id="临检jwt限制敏感操">临检JWT限制敏感操</h3>
<blockquote>
<p>一些涉及敏感数据变动时，执行临检操作(不用Redis)。</p>
</blockquote>
<p>在涉及到：<strong>新增、修改、删除、上传、下载</strong>等敏感操作时(支付)，强制检查用户身份，如<strong>手机验证码、扫描二维码</strong>等手段，确认操作者是用户本人</p>
<h3 id="异常jwt监控超频识别与限制">异常JWT监控：超频识别与限制</h3>
<blockquote>
<p>当JWT令牌被盗取，一般会出现<strong>高频次的系统访问</strong>。</p>
</blockquote>
<p>监控用户端在单位时间内的请求次数，当单位时间内的请求<strong>超出预定阈值</strong>时，则判定该用户的JWT令牌异常。(限制访问、冻结、IP限制、封号)</p>
<h3 id="地域检查杜绝jwt泄露可能">地域检查杜绝JWT泄露可能</h3>
<blockquote>
<p>一般用户活动范围是固定的，意味着JWT客户端访问IP相对固定，JWT泄露后，可能会出现异地登录的情况。</p>
</blockquote>
<p>对JWT进行异地访问检查，有效时间内，IP频繁变动可判断JWT泄露。(账号异地登录，邮箱，手机提醒)</p>
<h3 id="客户端区分检查防止jwt泄露">客户端区分检查防止JWT泄露</h3>
<blockquote>
<p>对于APP产品来说，一般客户端是固定的，基本为移动设备(APP，平板)，可以结合设备机器码进行绑定。</p>
</blockquote>
<p>将<strong>JWT与机器码绑定</strong>，存储于服务端，当客户端发起请求时，通过检查客户端的机器码于服务端机器码是否匹配判断JWT是否泄露。(判断JWT可能被盗，机器码不匹配，重新登录)</p>
<h3 id="jwt令牌保护限时限数限频">JWT令牌保护：限时、限数、限频</h3>
<blockquote>
<p>进行泄露识别，做好泄露后补救保证系统安全</p>
</blockquote>
<p>对客户端进行合理限制，限制每个客户端的JWT令牌数量、访问频率、JWT令牌时效等，以降低JWT令牌泄露的风险。</p>
<h2 id="面试题">面试题</h2>
<blockquote>
<p>什么是JWT？解释一下它的结构</p>
</blockquote>
<p>JWT是一种<strong>开放标准</strong>，用于在网络上安全地传输信息。它由三部分组成：<strong>头部、载荷和签名</strong>。</p>
<p>头部包含令牌的元数据，载荷包含实际的信息(用户ID、角色等)，签名用于验证令牌是否被篡改</p>
<blockquote>
<p>JWT的优点是什么? 它与传统的session-based身份验证相比有什么优缺点?</p>
</blockquote>
<p>JWT的优点包括<strong>无状态、可扩展、跨语言、易于实现和良好的安全性</strong>。相比之下，传统的<code>session-based</code>身份验证需要在<strong>服务端维护会话状态</strong>，使得服务端的<strong>负载更高</strong>，并且不<strong>适用于分布式系统</strong>。</p>
<blockquote>
<p>在WT的结构中，分别有哪些部分? 每个部分的作用是什么?</p>
</blockquote>
<p>JWT的结构由三部分组成:头部、载荷和签名。头部包合令牌类型和算法，载荷包含实际的信息，签名由头部、载荷和密钥生成。</p>
<blockquote>
<p>JWT如何工作? 从开始到验证过程的完整流程是怎样的?</p>
</blockquote>
<p>JWT的工作流程分为三个步骤:<strong>生成令牌、发送令牌、验证令牌。</strong></p>
<p>在生成令牌时，服务端使用密钥对头部和载荷进行<strong>签名</strong>。</p>
<p>在发送令牌时，将令牌<strong>发送</strong>给客户端。</p>
<p>在验证令牌时，客户端从令牌中解析出<strong>头部和载荷</strong>，并使用<strong>相同的密钥验证签名</strong>。</p>
<blockquote>
<p>什么是JWT的签名? 为什么需要对]WT进行签名? 如何验证JWT的签名?</p>
</blockquote>
<p>JWT的签名是由<strong>头部、载荷和密钥</strong>生成的，用于验证令牌<strong>是否被算改</strong>。</p>
<p>签名使用<strong>HMAC算法</strong>或<strong>RSA算法</strong>生成。</p>
<p>在验证JWT的签名时，客户端使用相同的<strong>密钥和算法</strong>生成<strong>签名</strong>，并将生成的签名与令牌中的签名<strong>进行比较</strong>。</p>
<blockquote>
<p>什么是IWT的令牌刷新? 为什么需要这个功能?</p>
</blockquote>
<p>令牌刷新是一种<strong>机制</strong>，用于解决<strong>JWT过期</strong>后需要重新登录的问题。在令牌刷新中，服务端生成新的]WT，并将其发送给客户端。客户端使用新的WT替换旧的JWT，从而延长令牌的有效期。</p>
<blockquote>
<p>JWT是否加密?如果是，加密的部分是哪些? 如果不是，那么它如何保证数据安全性?</p>
</blockquote>
<p>JWT本身并不加密，但可以在载荷中包含敏感信息。为了保护这些信息，可以使用<code>]WE (SON Web Encryption)</code>对载荷进行加密。如果不加密，则需要在生成JWT时确保<strong>不在载荷中包含敏感信息</strong>。</p>
<blockquote>
<p>在JWT中，如何处理Token过期的问题? 有哪些方法可以处理?</p>
</blockquote>
<p>JWT过期后，客户端需要重新获取新的WT。可以通过在]WT中包含<strong>过期时间</strong>或使用<code>refresh token</code>等机制来解决过期问题。</p>
<blockquote>
<p>JWT和OAuth2有什么关系? 它们之间有什么区别?</p>
</blockquote>
<p><code>JWT</code>和<code>OAuth2</code>都是用于<strong>身份验证和授权</strong>的<strong>开放标准</strong>。JWT是一种<strong>身份验证机制</strong>，而OAuth2是一种<strong>授权机制</strong>。JWT用于在<strong>不同的系统中安全地传输信息</strong>，OAuth2用于<strong>授权第三方应用程序访问受保护的资源</strong>。</p>
<blockquote>
<p>JWT在什么场景下使用较为合适? 它的局限性是什么?</p>
</blockquote>
<p>JWT在<strong>单体应用或微服务架构</strong>中的使用比较合适。它的局限性包括<strong>无法撤销、令牌较大、无法处理并发</strong>等问题。</p>
<p>在需要针对每次请求进行<strong>访问控制</strong>或<strong>需要撤销令牌</strong>的情况下，JWT可能<strong>不是最佳选择</strong>。</p>
<p>场景应用：<strong>(邮箱激活、令牌登录)</strong></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-afd7f7b25840af8cd0e8d313baea0879">RESTful</h1>
	
	<div class="td-byline mb-4">
		作者: <b>XW</b> |
        
	</div>
	<h2 id="restful">RESTful</h2>
<blockquote>
<p>7个HTTP方法：GET/POST/PUT/DELETE/PATCH/HEAD/OPTIONS</p>
</blockquote>
<h3 id="接口规范">接口规范</h3>
<blockquote>
<p>增/删/改/查</p>
<p>PSOT/DELETE/PUT/GET</p>
<blockquote>
<p>安全：会不会出现重读、幻读、脏读（数据对不对、数量对不对）</p>
<p>幂等：在操作成功的前提下，会不会对数据库造成额外不好的影响</p>
</blockquote>
</blockquote>
<p><code>GET</code> 查询</p>
<blockquote>
<p>安全且幂等</p>
</blockquote>
<p><code>POST</code> 插入</p>
<blockquote>
<p>不安全且不幂等</p>
<p>不幂等：可能因网络原因，导致插入多条重复记录，但ID不一样</p>
</blockquote>
<p><code>PUT</code> 修改(更新)</p>
<blockquote>
<p>不安全但幂等</p>
<p>幂等：多次操作执行后只存在一个有效结果</p>
</blockquote>
<p><code>DELETE</code> 删除</p>
<blockquote>
<p>不安全但幂等</p>
</blockquote>
<h2 id="curl命令">CURL命令</h2>
<blockquote>
<p>Command Line URL viewer</p>
</blockquote>
<pre tabindex="0"><code># 默认GET请求
curl http://www.baidu.com/
curl -XGET [PATH]
# POST请求
curl -XPOST [PATH]
# 整个请求过程都能看见(请求头、请求体、响应头)
curl -v -XPOST [PATH]
</code></pre><h2 id="heading"></h2>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-ab3aaaa7b66c7c4bce279dd87d4ef870">ruoyi</h1>
	
	<div class="td-byline mb-4">
		作者: <b>XW</b> |
        
	</div>
	<h1 id="若以前后端分离">若以前后端分离</h1>
<h2 id="ruoyihttpdocruoyivip"><a href="http://doc.ruoyi.vip/">RuoYi</a></h2>
<h2 id="配置环境">配置环境</h2>
<p><a href="http://doc.ruoyi.vip/ruoyi/document/hjbs.html#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">环境部署 | RuoYi</a></p>
<ol>
<li>导入数据库</li>
</ol>
<pre tabindex="0"><code>quartz.sql
ry_20230706.sql
</code></pre><ol start="2">
<li>配置mysql数据库连接配置</li>
<li>安装Redis</li>
<li>启动后端项目<code>ruoyi-admin</code></li>
<li>查看前端项目<code>ruoyi-ui</code> 的<code>README.md</code>说明文档</li>
<li>启动前端项目，访问http://localhost:81/</li>
</ol>
<h2 id="启动报错">启动报错</h2>
<blockquote>
<p>原因：Node版本过高</p>
</blockquote>
<p><font color="red"><code>error:03000086:digital envelope routines::initialization error</code></font></p>
<p>解决方法</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 修改环境变量</span>
</span></span><span style="display:flex;"><span><span style="color:#000">$env</span>:NODE_OPTIONS<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;--openssl-legacy-provider&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>npm run dev
</span></span></code></pre></div><h2 id="文件结构">文件结构</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>com.ruoyi     
</span></span><span style="display:flex;"><span>├── common            // 工具类
</span></span><span style="display:flex;"><span>│       └── annotation                    // 自定义注解
</span></span><span style="display:flex;"><span>│       └── config                        // 全局配置
</span></span><span style="display:flex;"><span>│       └── constant                      // 通用常量
</span></span><span style="display:flex;"><span>│       └── core                          // 核心控制
</span></span><span style="display:flex;"><span>│       └── enums                         // 通用枚举
</span></span><span style="display:flex;"><span>│       └── exception                     // 通用异常
</span></span><span style="display:flex;"><span>│       └── json                          // JSON数据处理
</span></span><span style="display:flex;"><span>│       └── utils                         // 通用类处理
</span></span><span style="display:flex;"><span>│       └── xss                           // XSS过滤处理
</span></span><span style="display:flex;"><span>├── framework         // 框架核心
</span></span><span style="display:flex;"><span>│       └── aspectj                       // 注解实现
</span></span><span style="display:flex;"><span>│       └── config                        // 系统配置
</span></span><span style="display:flex;"><span>│       └── datasource                    // 数据权限
</span></span><span style="display:flex;"><span>│       └── interceptor                   // 拦截器
</span></span><span style="display:flex;"><span>│       └── manager                       // 异步处理
</span></span><span style="display:flex;"><span>│       └── shiro                         // 权限控制
</span></span><span style="display:flex;"><span>│       └── web                           // 前端控制
</span></span><span style="display:flex;"><span>├── ruoyi-generator   // 代码生成（不用可移除）
</span></span><span style="display:flex;"><span>├── ruoyi-quartz      // 定时任务（不用可移除）
</span></span><span style="display:flex;"><span>├── ruoyi-system      // 系统代码
</span></span><span style="display:flex;"><span>├── ruoyi-admin       // 后台服务
</span></span><span style="display:flex;"><span>├── ruoyi-xxxxxx      // 其他模块
</span></span></code></pre></div><h2 id="登录">登录</h2>
<h3 id="业务层">业务层</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 登录验证
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param username 用户名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param password 密码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param code 验证码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param uuid 唯一标识
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return 结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">login</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">code</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">uuid</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 验证码校验
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// 登录前置校验
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// 用户验证
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// 生成token返回
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>         
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 校验验证码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param username 用户名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param code 验证码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param uuid 唯一标识
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return 结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">validateCaptcha</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">code</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">uuid</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>         <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 登录前置校验
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param username 用户名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param password 用户密码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">loginPreCheck</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 用户名或密码为空 错误
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// 密码如果不在指定范围内 错误
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// 用户名不在指定范围内 错误
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// IP黑名单校验
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        
</span></span><span style="display:flex;"><span>         <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 记录登录信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param userId 用户ID
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">recordLoginInfo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Long</span> <span style="color:#000">userId</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="控制层">控制层</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 生成验证码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/captchaImage&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">AjaxResult</span> <span style="color:#000">getCode</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HttpServletResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 登录方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param loginBody 登录信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return 结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/login&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">AjaxResult</span> <span style="color:#000">login</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestBody</span> <span style="color:#000">LoginBody</span> <span style="color:#000">loginBody</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 获取用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return 用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;getInfo&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">AjaxResult</span> <span style="color:#000">getInfo</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 获取路由信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return 路由信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;getRouters&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">AjaxResult</span> <span style="color:#000">getRouters</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="后端">后端</h3>
<h4 id="验证码生成">验证码生成</h4>
<blockquote>
<p>后端生成一个表达式：1+1=2</p>
</blockquote>
<p><code>1+1=?@2</code></p>
<p><code>@</code>符号分割</p>
<p>验证码显示部分：1+1=?</p>
<p>答案：2	存入Redis</p>
<p>流程：</p>
<ol>
<li>前端发送请求<code>/getCodeImg</code>请求</li>
<li>后端生成验证码和UUID返回给前端</li>
<li>将答案和UUID存放到Redis上</li>
<li>用户输入验证码，发送<code>/login</code>请求(传送<strong>验证码、UUID</strong>信息)</li>
<li>后端拿到<code>UUID</code>查询Redis内验证码进行对比</li>
</ol>
<h4 id="captchacontroller-生成验证码接口">CaptchaController 生成验证码接口</h4>
<p><code>com.ruoyi.web.controller.common.CaptchaController</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 验证码操作处理
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @author ruoyi
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">CaptchaController</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Resource</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;captchaProducer&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Producer</span> <span style="color:#000">captchaProducer</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Resource</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;captchaProducerMath&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Producer</span> <span style="color:#000">captchaProducerMath</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">RedisCache</span> <span style="color:#000">redisCache</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">ISysConfigService</span> <span style="color:#000">configService</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 生成验证码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/captchaImage&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">AjaxResult</span> <span style="color:#000">getCode</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HttpServletResponse</span> <span style="color:#000">response</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">AjaxResult</span> <span style="color:#000">ajax</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AjaxResult</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">success</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">captchaEnabled</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">selectCaptchaEnabled</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ajax</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;captchaEnabled&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">captchaEnabled</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(!</span><span style="color:#000">captchaEnabled</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ajax</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 保存验证码信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">String</span> <span style="color:#000">uuid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">IdUtils</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">simpleUUID</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">String</span> <span style="color:#000">verifyKey</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">CacheConstants</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">CAPTCHA_CODE_KEY</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">uuid</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">String</span> <span style="color:#000">capStr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">code</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">BufferedImage</span> <span style="color:#000">image</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 生成验证码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">String</span> <span style="color:#000">captchaType</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RuoYiConfig</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getCaptchaType</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;math&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">equals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">captchaType</span><span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">String</span> <span style="color:#000">capText</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">captchaProducerMath</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">createText</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">capStr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">capText</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">substring</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">capText</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">lastIndexOf</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;@&#34;</span><span style="color:#ce5c00;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">code</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">capText</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">substring</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">capText</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">lastIndexOf</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;@&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">image</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">captchaProducerMath</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">createImage</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">capStr</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;char&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">equals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">captchaType</span><span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">capStr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">code</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">captchaProducer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">createText</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">image</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">captchaProducer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">createImage</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">capStr</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">redisCache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setCacheObject</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">verifyKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">code</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Constants</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">CAPTCHA_EXPIRATION</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">TimeUnit</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">MINUTES</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 转换流信息写出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">FastByteArrayOutputStream</span> <span style="color:#000">os</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">FastByteArrayOutputStream</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">try</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">ImageIO</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">write</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">image</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;jpg&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">IOException</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">AjaxResult</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">error</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getMessage</span><span style="color:#ce5c00;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ajax</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uuid&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">uuid</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ajax</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;img&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Base64</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">encode</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">toByteArray</span><span style="color:#ce5c00;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ajax</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="登录的具体流程">登录的具体流程</h4>
<blockquote>
<ol>
<li>校验验证码(Redis)</li>
<li>校验用户名和密码(Mysql)</li>
<li>生成Token</li>
</ol>
</blockquote>
<p>使用异步任务管理器，结合线程池，实现异步的操作日志记录，和业务逻辑实现异步解耦合</p>
<h4 id="sysloginservice"><code>SysLoginService</code></h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 登录验证
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param username 用户名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param password 密码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param code 验证码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param uuid 唯一标识
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return 结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">login</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">code</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">uuid</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 验证码校验
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">validateCaptcha</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">code</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">uuid</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 登录前置校验
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">loginPreCheck</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 用户验证
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">Authentication</span> <span style="color:#000">authentication</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">try</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">UsernamePasswordAuthenticationToken</span> <span style="color:#000">authenticationToken</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">UsernamePasswordAuthenticationToken</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">AuthenticationContextHolder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setContext</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">authenticationToken</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// 该方法会去调用UserDetailsServiceImpl.loadUserByUsername
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">authentication</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">authenticationManager</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">authenticate</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">authenticationToken</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Exception</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">e</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">BadCredentialsException</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">AsyncManager</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">me</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">execute</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncFactory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">recordLogininfor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Constants</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">LOGIN_FAIL</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">MessageUtils</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">message</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;user.password.not.match&#34;</span><span style="color:#ce5c00;font-weight:bold">)));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">UserPasswordNotMatchException</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">AsyncManager</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">me</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">execute</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncFactory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">recordLogininfor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Constants</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">LOGIN_FAIL</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getMessage</span><span style="color:#ce5c00;font-weight:bold">()));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ServiceException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getMessage</span><span style="color:#ce5c00;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">finally</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">AuthenticationContextHolder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">clearContext</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">AsyncManager</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">me</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">execute</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncFactory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">recordLogininfor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Constants</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">LOGIN_SUCCESS</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">MessageUtils</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">message</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;user.login.success&#34;</span><span style="color:#ce5c00;font-weight:bold">)));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">LoginUser</span> <span style="color:#000">loginUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">LoginUser</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">authentication</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getPrincipal</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">recordLoginInfo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">loginUser</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getUserId</span><span style="color:#ce5c00;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 生成token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">tokenService</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">createToken</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">loginUser</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 校验验证码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param username 用户名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param code 验证码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param uuid 唯一标识
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return 结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">validateCaptcha</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">code</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">uuid</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">captchaEnabled</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">configService</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">selectCaptchaEnabled</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">captchaEnabled</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">String</span> <span style="color:#000">verifyKey</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">CacheConstants</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">CAPTCHA_CODE_KEY</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">StringUtils</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">nvl</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">uuid</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">String</span> <span style="color:#000">captcha</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redisCache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getCacheObject</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">verifyKey</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">redisCache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">deleteObject</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">verifyKey</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">captcha</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">AsyncManager</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">me</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">execute</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncFactory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">recordLogininfor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Constants</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">LOGIN_FAIL</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">MessageUtils</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">message</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;user.jcaptcha.expire&#34;</span><span style="color:#ce5c00;font-weight:bold">)));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">CaptchaExpireException</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(!</span><span style="color:#000">code</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">equalsIgnoreCase</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">captcha</span><span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">AsyncManager</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">me</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">execute</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">AsyncFactory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">recordLogininfor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Constants</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">LOGIN_FAIL</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">MessageUtils</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">message</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;user.jcaptcha.error&#34;</span><span style="color:#ce5c00;font-weight:bold">)));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">CaptchaException</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="前端">前端</h3>
<h4 id="前端解决跨域问题">前端解决跨域问题</h4>
<blockquote>
<p>调用接口：<code>http://localhost:81/dev-api/captchaImage</code>（调用的前端地址）</p>
<p>前端反向代理解决跨域问题</p>
<p>url请求前端，进行<strong>反向代理</strong>，映射到后端，<strong>解决跨域问题</strong></p>
<ol>
<li>后端解决跨域问题</li>
<li>前端解决跨域问题</li>
</ol>
</blockquote>
<p><a href="https://cloud.tencent.com/developer/article/1924258">https://cloud.tencent.com/developer/article/1924258</a></p>
<p><a href="https://blog.csdn.net/qq_34383510/article/details/115702113">后端接收不到前端传入的header参数信息_请求前端header携带到后端_.猫的树的博客-CSDN博客</a></p>
<p><code>@/vue.config.js</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span> <span style="color:#000">proxy</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// detail: https://cli.vuejs.org/config/#devserver-proxy
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:bold">[</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VUE_APP_BASE_API</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">target</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">`http://localhost:8080`</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">changeOrigin</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 路径重写，将/dev-api替换为&#39;&#39;再映射到http://localhost:8080
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// http://localhost:8080/captchaImage
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">pathRewrite</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;^&#39;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">process</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VUE_APP_BASE_API</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span></code></pre></div><pre tabindex="0"><code>module.exports = {
  publicPath: &#39;./&#39;,
  productionSourceMap: false,
  devServer: {
    proxy: {
      &#39;/api&#39;: {
        target: &#34;http://localhost:8088/vaccinum&#34;, // 访问的后台地址
        changeOrigin: true,
        pathRewrite: { // 重写地址 你的接口地址是&#39;http://10.10.1.10/login&#39; 你请求得时候地址只需要写&#39;/api/login&#39;
          &#39;/api&#39;: &#39;&#39;
        }
      }
    }
  }
};
</code></pre><h4 id="api接口调用">API接口调用</h4>
<ol>
<li><code>@/views/login.vue</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000">getCode</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">getCodeImg</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">captchaEnabled</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">captchaEnabled</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#204a87;font-weight:bold">undefined</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">captchaEnabled</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">captchaEnabled</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">codeUrl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;data:image/gif;base64,&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">img</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">loginForm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">uuid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">uuid</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span></code></pre></div><ol start="2">
<li><code>@/api/login.js</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 获取验证码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getCodeImg</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">url</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;/captchaImage&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">headers</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">isToken</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;get&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">20000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ol start="3">
<li><code>@/utils/request.js</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 创建axios实例
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">service</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">axios</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// axios中请求配置有baseURL选项，表示请求URL公共部分
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">baseURL</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">process</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VUE_APP_BASE_API</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 超时
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10000</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><p><code>ruoyi-ui/.env.development</code>开发环境</p>
<pre tabindex="0"><code># 页面标题
VUE_APP_TITLE = 若依管理系统

# 开发环境配置
ENV = &#39;development&#39;

# 若依管理系统/开发环境
VUE_APP_BASE_API = &#39;/dev-api&#39;

# 路由懒加载
VUE_CLI_BABEL_TRANSPILE_MODULES = true
</code></pre>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-ce94205a00302c2292e49c3c5d0504d5">SpringSecurity</h1>
	
	<div class="td-byline mb-4">
		作者: <b>XW</b> |
        
	</div>
	<h2 id="springsecurity">SpringSecurity</h2>
<h3 id="权限管理">权限管理</h3>
<blockquote>
<p>权限管理是管理系统中，针对不同用户对不同<strong>资源</strong>的访问权限进行控制的<strong>过程</strong>。</p>
<p>只有<strong>授权用户</strong>才能访问敏感信息或执行的任务，从而保护系统的安全性和完整性</p>
</blockquote>
<p>权限管理通常包含的步骤：</p>
<ol>
<li>确认用户身份：用户登录，通过用户认证信息来验证用户身份。</li>
<li>为用户分配角色：为每个用户分配一个或多个角色，以确定他们能够访问哪些资源</li>
<li>为用户分配权限：为每个(用户/角色)分配一个或多个权限，以确定他们能够访问哪些资源。RBAC模型中，将权限分配给角色</li>
<li>管理权限：对资源进行权限控制，访问资源的用户必须具备需要的权限才能访问</li>
</ol>
<h3 id="权限管理相关概念">权限管理相关概念</h3>
<h4 id="资源">资源</h4>
<blockquote>
<p>可以是软件系统中任意存在的实体，如：访问目录、文件、数据库中的数据、方法等</p>
<p>在B/S模式中，如：处理请求的方法(Servlet、Controller)、图片、HTML、JS、CSS等</p>
</blockquote>
<h4 id="权限privilege">权限(privilege)</h4>
<blockquote>
<p>B/S模式中，访问某一个URL的权限，在表中储存方式：</p>
</blockquote>
<table>
<thead>
<tr>
<th>ID</th>
<th>权限</th>
<th>资源名称</th>
<th>URL</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>用户管理权限</td>
<td>用户查询</td>
<td>/selectUser</td>
</tr>
<tr>
<td>2</td>
<td>用户管理权限</td>
<td>用户修改</td>
<td>/updateUser</td>
</tr>
<tr>
<td>3</td>
<td>用户管理权限</td>
<td>用户删除</td>
<td>/deleteUser</td>
</tr>
</tbody>
</table>
<blockquote>
<p>资源通常是同URL进行去控制权限，权限对应的某些资源，一个权限可以对应一个资源，也可以对应多个资源</p>
</blockquote>
<p>用户-角色-权限-资源</p>
<h4 id="主体principal">主体(principal)</h4>
<blockquote>
<p>用户，用户拥有账号、密码、角色、权限等基本信息</p>
<p>一个用户具备多个权限</p>
</blockquote>
<h4 id="认证authentication">认证(authentication)</h4>
<blockquote>
<p>认证是权限管理系统判断用户(主体)身份是否合法的过程</p>
<p>用户登录过程</p>
</blockquote>
<p>常见认证方式：账号密码认证、扫码认证、手机短信验证码认证、指纹识别等</p>
<h4 id="授权authorization">授权(authorization)</h4>
<blockquote>
<p>授权是将访问软件系统资源的<strong>权力</strong>授予<strong>主体</strong>的过程</p>
<p>授权通过后，用户具备系统中访问特定功能的能力</p>
<p>通常，<strong>先认证(登录)再授权</strong>，授权一般是为用户授予访问当前资源的权限</p>
</blockquote>
<p>用户登录后，在session中保存用户权限、角色等信息。</p>
<p>用户在访问的时候，服务端获取用户的**权限列表(角色)**判断是否具有访问当前资源的权限（授权）。</p>
<h4 id="权限管理-1">权限管理</h4>
<blockquote>
<p>权限管理是针对主题、全新啊、资源进行统一管理的方式</p>
</blockquote>
<p>用户的权限：系统超级管理员分配 或 升级(达到预期的某种条件)</p>
<h3 id="权限管理的实现">权限管理的实现</h3>
<h4 id="认证流程">认证流程</h4>
<ol>
<li>账号密码</li>
<li>查询用户</li>
<li><strong>用户是否存在</strong></li>
<li><strong>密码是否正确</strong></li>
<li>查询用户具备的权限信息</li>
<li>保存用户的登录状态</li>
<li>登录成功</li>
</ol>
<h4 id="访问控制">访问控制</h4>
<ol start="8">
<li>用户访问<code>/userDetail</code>接口</li>
<li>从请求中获取用户唯一标识</li>
<li>从session中查询用户</li>
<li><strong>用户是否存在</strong>(唯一标识、令牌)</li>
<li><strong>用户是否具备访问当前资源的权限</strong>(权限列表)</li>
<li>放行访问</li>
<li>返回访问的资源</li>
</ol>
<h3 id="rbac模型">RBAC模型</h3>
<h4 id="传统权限模型">传统权限模型</h4>
<p>用户和权限为多对多关系，用中间表维护</p>
<table>
<thead>
<tr>
<th>用户ID</th>
<th>权限ID</th>
</tr>
</thead>
</table>
<p>缺点：操作维护麻烦</p>
<h4 id="rbac模型-1">RBAC模型</h4>
<blockquote>
<p>基于角色的访问控制(Role-Based Access Control)</p>
<p>是一套成熟的权限模型</p>
<p>可以使用权限框架整合RBAC模型实现</p>
</blockquote>
<p>将权限赋予角色，再将角色赋予用户</p>
<p>让维护权限关系的行为变的更加简单</p>
<blockquote>
<p>在RBAC模型设计中，根据权限的复杂程度，可分为<strong>RBAC0、RBAC1、RBAC2、RBAC3</strong>四个级别。</p>
</blockquote>
<p>RBAC0是基础，也叫RBAC模型，RBAC1、RBAC2、RBAC3都是RBAC0为基础的升级。</p>
<p>传统权限模型：</p>
<p>用户——权限</p>
<p>RBAC权限模型：</p>
<p>用户——角色——权限</p>
<h5 id="rbac0">RBAC0</h5>
<blockquote>
<p>用户n——m角色n——m权限(多对多关系)</p>
</blockquote>
<p><strong>用户表—中间表—角色表—中间表—权限表</strong></p>
<h5 id="rbac1">RBAC1</h5>
<blockquote>
<p>在角色中引入继承的概念，将角色分成几个等级，每个等级权限不同，从而实现更细粒度的权限管理</p>
</blockquote>
<p>用户n——m角色(等级1、等级2、等级3)n——m权限(多对多关系)</p>
<p>部门经理细分：经理、副经理</p>
<p>进行细粒度的拆分控制</p>
<h5 id="rbac2">RBAC2</h5>
<blockquote>
<p>仅是对用户、角色和权限三者增加了一些限制。</p>
<p>可分为两类：<strong>静态职责分离SSD</strong>(Static Separation of Duty) 和 <strong>动态职责分离DSD</strong>(Dynamic Separation of Duty)。</p>
</blockquote>
<p><strong>静态职责分离SSD：</strong></p>
<ul>
<li>互斥角色限制：同一个用户在<strong>两个互斥角色</strong>中只能选择<strong>一个</strong>，例如:在为员工分类角色时，<strong>不可以</strong>把<strong>财务</strong>和<strong>出纳</strong>分配给同一个人。</li>
<li>基数限制：一个用户拥有的<strong>角色</strong>是<strong>有限的</strong>，一个角色拥有的<strong>权限</strong>也是<strong>有限的</strong>。这很好理解，<strong>根据实际业务决定</strong>，想想给一个用户无限添加角色、权限也未必是合理的。</li>
<li>先决条件限制：用户想要获得<strong>更高级的角色</strong>，首先必须拥有<strong>低级角色</strong>，这样做的好处就是，<strong>不需要</strong>为高级角色<strong>重新分配</strong>一遍<strong>低级角色</strong>具备的所有权限，例如: 赋予用户部门经理角色，<strong>预先赋予该用户一线员工、小组长等角色</strong>。</li>
</ul>
<p><strong>动态职责分离DSD：</strong></p>
<ul>
<li>
<p>动态的限制用户拥有的角色，比如，一个用户可以拥有多个角色，但<strong>运行时只能激活一个角色</strong></p>
<p>例如：曾经我在某机构做<strong>课程研究员</strong>，登录公司的教学管理平台后，左侧菜单显示的是<strong>课程研究员的权限列表</strong>。当我被派往学院授课，于是我就具备了<strong>讲师的角色</strong>，讲师角色拥有的权限与<strong>课程研究员角色</strong>拥有的权限列表是<strong>不一样的。</strong></p>
<p>并且我如果以<strong>课程研究员</strong>的角色<strong>去操作讲师角色特有的权限</strong>，是不是也<strong>不合适</strong>?</p>
<p>于是在项目的右上角有一个<strong>切换角色的选项</strong>，切换成不同的角色，左侧菜单<strong>显示对应的菜单列表</strong></p>
</li>
</ul>
<h5 id="统一模型rbac3">统一模型RBAC3</h5>
<blockquote>
<p><strong>RBAC3 = RBAC1 + RBAC2</strong></p>
<p>既有角色分层，也包含可以曾各种限制</p>
</blockquote>
<p>只在系统对权限要求非常复杂时，才考虑使用此权限模型</p>
<p>场景：OA办公自动化系统、生产制造</p>
<h4 id="基于rbac的延展用户组">基于RBAC的延展——用户组</h4>
<blockquote>
<p>直接给用户组分配角色，再吧用户加入用户组。(Linux用户组)</p>
<p>用户除了拥有自身的权限外，还拥有了所属用户组的所有权限</p>
</blockquote>
<p>用户——用户组——角色——权限</p>
<h3 id="rbac实现">RBAC实现</h3>
<ul>
<li>手动编码</li>
<li>shiro框架</li>
<li>springSecurity框架</li>
</ul>
<h4 id="rbac数据模型">RBAC数据模型</h4>
<center>用户表user</center>
<table>
<thead>
<tr>
<th>字段名称</th>
<th>字段</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>用户ID</td>
<td>id</td>
<td>int</td>
<td>主键</td>
</tr>
<tr>
<td>用户名</td>
<td>username</td>
<td>varchar(20)</td>
<td>not null</td>
</tr>
<tr>
<td>密码</td>
<td>password</td>
<td>varchar(100)</td>
<td>not null</td>
</tr>
<tr>
<td>电子邮箱</td>
<td>email</td>
<td>varchar(30)</td>
<td>not null</td>
</tr>
</tbody>
</table>
<center>角色表roles</center>
<table>
<thead>
<tr>
<th>字段名称</th>
<th>字段</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>角色ID</td>
<td>id</td>
<td>int</td>
<td>外键</td>
</tr>
<tr>
<td>角色名称</td>
<td>name</td>
<td>varchar(20)</td>
<td>not null</td>
</tr>
</tbody>
</table>
<center>权限表permissions</center>
<table>
<thead>
<tr>
<th>字段名称</th>
<th>字段</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>权限ID</td>
<td>id</td>
<td>int</td>
<td>主键</td>
</tr>
<tr>
<td>权限名称</td>
<td>name</td>
<td>varchar(20)</td>
<td>not null</td>
</tr>
<tr>
<td>权限描述</td>
<td>description</td>
<td>varchar(20)</td>
<td></td>
</tr>
</tbody>
</table>
<center>角色——权限关联表role_permissions</center>
<table>
<thead>
<tr>
<th>字段名称</th>
<th>字段</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>角色ID</td>
<td>role_id</td>
<td>int</td>
<td>外键role(id)</td>
</tr>
<tr>
<td>权限ID</td>
<td>permission_id</td>
<td>int</td>
<td>外键permissions(id)</td>
</tr>
</tbody>
</table>
<center>用户——角色关联表user_roles</center>
<table>
<thead>
<tr>
<th>字段名称</th>
<th>字段</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>用户ID</td>
<td>user_id</td>
<td>int</td>
<td>外键user(id)</td>
</tr>
<tr>
<td>角色ID</td>
<td>role_id</td>
<td>int</td>
<td>外键roles(id)</td>
</tr>
</tbody>
</table>
<p>menu</p>
<table>
<thead>
<tr>
<th>字段名称</th>
<th>字段</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>菜单ID</td>
<td>id</td>
<td>int</td>
<td></td>
</tr>
<tr>
<td>菜单名</td>
<td>menu_name</td>
<td>varchar</td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="登录应用">登录应用</h4>
<ol>
<li>用户登录成功后</li>
<li>查询用户角色</li>
<li>查询用户权限</li>
<li>缓存用户数据到<code>Session</code>或<code>Redis</code></li>
<li>用户访问资源，发送token</li>
<li>从redis查询token并获取用户数据</li>
<li>判断访问资源是否受限**(需不需要登录后才能访问)**</li>
<li>受限则判断用户是否具备访问权限，具备则<strong>响应资源</strong>，不具备，<strong>拒绝访问</strong></li>
</ol>
<h4 id="spring-security3x">Spring Security3.X</h4>
<blockquote>
<p>是一个功能强大且高度可定制的<strong>身份认证和访问控制框架</strong>，用于Java应用程序提供<strong>身份认证</strong>和<strong>授权</strong></p>
<p>它是用于保护基于Spring程序的安全框架</p>
</blockquote>
<h5 id="入门">入门</h5>
<p><a href="https://docs.spring.io/spring-security/reference/">Spring Security :: Spring Security</a></p>
<blockquote>
<p>开发环境：<strong>JDK17以上、SpringBoot3.X、SpringSecurity6.X</strong></p>
</blockquote>
<h4 id="spring-security2x">Spring Security2.X</h4>
<p>原理：一个过滤器链</p>
<p>监听器》过滤器链》dispatcherservlet(前置过滤器》mapperHandle》后置拦截器》最终拦截器)</p>
<blockquote>
<p>请求</p>
<ol>
<li>
<p>UsernamePasswordAuthenticationFilter</p>
</li>
<li>
<p>ExceptionTranslationFilter</p>
</li>
<li>
<p>FilterSecurityInterceptor</p>
</li>
</ol>
<p>API</p>
<ol>
<li>
<p>FilterSecurityInterceptor</p>
</li>
<li>
<p>ExceptionTranslationFilter</p>
</li>
<li>
<p>UsernamePasswordAuthenticationFilter</p>
</li>
</ol>
<p>响应</p>
</blockquote>
<p><code>UsernamePasswordAuthenticationFilter</code>：负责处理我们在登录页面填写了用户名密码后的登录请求。(认证)</p>
<p><code>ExceptionTranslationFilter</code>：处理过滤链抛出的任何<code>AccessDeniedException</code>和<code>AutheenticationException</code></p>
<p><code>FilterSecurityInterceptor</code>：负责权限校验的过滤器</p>
<h5 id="认证流程-1">认证流程</h5>
<ol>
<li>
<p><code>UsernamePasswordAuthenticationFilter</code>(重写，登录控制器调用<code>authenticate</code>方法)</p>
</li>
<li>
<p><code>ProviderManager</code>(<code>AuthenticationManager</code>接口)的<code>authenticate</code>方法进行用户认证</p>
</li>
<li>
<p><code>DaoAuthenticationProvider</code> 调用<code>loadUserByUsername</code>方法</p>
</li>
<li>
<p><code>InMenoryUserDetailsManager</code>(<code>UserDetailsService</code>接口)(<code>UserDetailsServiceImpl</code>实现接口重写，从数据库查询)<code>loadUserByUsername</code>方法获取用户信息和用户权限</p>
</li>
</ol>
<p>概念：</p>
<p><code>Authentication</code>接口: 它的实现类，表示当前访问系统的用户，封装了用户相关信息。</p>
<p><code>AuthenticationManager</code>接口: 定义了认证<code>Authentication</code>的方法</p>
<p><code>UserDetailsService</code>接口: 加载用户特定数据的核心接口。里面定义了一个根据用户名查询用户信息的方法。</p>
<p><code>UserDetails</code>接口: 提供核心用户信息，通过<code>UserDetailsService</code>根据用户名获取处理的用户信息要封装成<code>UserDetails</code>对象返回。然后将这些信息封装到<code>Authentication</code>对象中</p>
<p>Jwt认证过滤器</p>
<ol>
<li>
<p>获取token</p>
</li>
<li>
<p>解析token</p>
</li>
<li>
<p>获取<code>userid</code>，从<code>redis</code>中获取用户信息(key:userid value:用户信息)</p>
</li>
<li>
<p>封装<code>Autehntication</code>对象存入<code>SecurityContextHolder</code></p>
</li>
</ol>
<p>其它过滤器</p>
<p>从<code>SecurityContextHolder</code>中获取当前请求用户信息</p>
<h5 id="实战">实战</h5>
<p>登录</p>
<ol>
<li>自定义登录接口，调用ProviderManager的方法进行认证(登录)</li>
<li>自定义UserDetailsService，查询数据库</li>
</ol>
<p>校验</p>
<ol>
<li>自定义Jwt认证过滤</li>
<li>获取token</li>
<li>解析token获取userid</li>
<li>从redis获取用户信息</li>
<li>存入SecurityContextHolder</li>
</ol>
<p>重写<code>UserDetails</code>实现类</p>
<blockquote>
<p><code>UserDetailsService</code>接口<code>loadUserByUsername</code>方法的返回对象</p>
<p>由<code>DaoAuthenticationProvider</code>调用</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@Data</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@NoArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@AllArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LoginUser</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">UserDetails</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 用户ID
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Long</span> <span style="color:#000">userId</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 用户唯一标识
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">token</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 登录时间
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Long</span> <span style="color:#000">loginTime</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 过期时间
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Long</span> <span style="color:#000">expireTime</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 登录IP地址
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">ipaddr</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 登录地点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">loginLocation</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 浏览器类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">browser</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 操作系统
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 权限列表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Set</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">permissions</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">User</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Collection</span><span style="color:#ce5c00;font-weight:bold">&lt;?</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">GrantedAuthority</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">getAuthorities</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">getPassword</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getPassword</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">getUsername</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getUsername</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">isAccountNonExpired</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">isAccountNonLocked</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">isCredentialsNonExpired</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">isEnabled</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>重写<code>UserDetailsService</code>实现类</p>
<blockquote>
<p>原<code>SpringSecurity</code>的实现类是从内存中查询用户信息</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UserDetailsServiceImpl</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">UserDetailsService</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">UserMapper</span> <span style="color:#000">userMapper</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">UserDetails</span> <span style="color:#000">loadUserByUsername</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">UsernameNotFoundException</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">LambdaQueryWrapper</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">queryWrapper</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">LambdaQueryWrapper</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">queryWrapper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">eq</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">getUsername</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 查询用户信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">User</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">userMapper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">selectOne</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">queryWrapper</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Objects</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">isNull</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">)){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">UsernameNotFoundException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;用户名或者密码错误&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">//TODO 查询用户的权限信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 吧数据封装成UserDetails返回
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">LoginUser</span> <span style="color:#000">loginUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">LoginUser</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">loginUser</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setUser</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">loginUser</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="配置类">配置类</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * SpringSecurity配置类
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @Author: zq
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @Date: 2023/08/04/2:14
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @Description:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@EnableWebSecurity</span> <span style="color:#8f5902;font-style:italic">// 添加 security 过滤器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@EnableGlobalMethodSecurity</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">prePostEnabled</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">)</span>	<span style="color:#8f5902;font-style:italic">// 启用方法级别的权限认证
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">SpringSecurityConfig</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    * 用户密码加密工具，注入容器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    * $2a(bcrypt加密版本号)$10(cost的值) 加密方式+ 盐(22位) + 密文
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    * $2a$10xxxxx/xxxxx/xxxx
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    * */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">AuthenticationConfiguration</span> <span style="color:#000">authenticationConfiguration</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">JwtAuthFilter</span> <span style="color:#000">jwtAuthFilter</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 认证异常处理
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">AuthenticationEntryPoint</span> <span style="color:#000">authenticationEntryPoint</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 授权异常处理
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">AccessDeniedHandler</span> <span style="color:#000">accessDeniedHandler</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 获取AuthenticationManager（认证管理器），登录时认证使用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @throws Exception
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">AuthenticationManager</span> <span style="color:#000">getAuthenticationManagerBean</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">authenticationConfiguration</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAuthenticationManager</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 用户密码加密方式配置
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">PasswordEncoder</span> <span style="color:#000">getPasswordEncoderBean</span><span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">BCryptPasswordEncoder</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 配置类
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param http
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">SecurityFilterChain</span> <span style="color:#000">filterChain</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HttpSecurity</span> <span style="color:#000">http</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">http</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// 基于 token，不需要 csrf
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">csrf</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">disable</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// 基于 token，不需要 session
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">sessionManagement</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">sessionCreationPolicy</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">SessionCreationPolicy</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">STATELESS</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">and</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// 下面开始设置权限
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">authorizeRequests</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">authorize</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">authorize</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#8f5902;font-style:italic">// 请求,允许匿名访问(登录后不能访问)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">antMatchers</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/login&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">anonymous</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">antMatchers</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/register&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">anonymous</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">antMatchers</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/captcha/*&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">anonymous</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//                        .antMatchers(&#34;/vaccinum-type/list&#34;).permitAll()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                        <span style="color:#8f5902;font-style:italic">// 其他地址的访问均需验证权限
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                        <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">anyRequest</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">authenticated</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// 在 UsernamePasswordAuthenticationFilter.class 过滤器之前
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#8f5902;font-style:italic">// 添加 JWT 过滤器，JWT 过滤器在用户名密码认证过滤器之前
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">addFilterBefore</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">jwtAuthFilter</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">UsernamePasswordAuthenticationFilter</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//                // 认证用户时用户信息加载配置，注入springAuthUserService
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//                .userDetailsService(userDetailsService)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">exceptionHandling</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">authenticationEntryPoint</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">authenticationEntryPoint</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">accessDeniedHandler</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">accessDeniedHandler</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">and</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">cors</span><span style="color:#ce5c00;font-weight:bold">()</span>     <span style="color:#8f5902;font-style:italic">// 允许跨域访问
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">and</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 配置跨源访问(CORS)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//    @Bean
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//    CorsConfigurationSource corsConfigurationSource() {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//        source.registerCorsConfiguration(&#34;/**&#34;, new CorsConfiguration().applyPermitDefaultValues());
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//        return source;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//    }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">SpringSecurityConfig</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">WebSecurityConfigurerAdapter</span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    * 用户密码加密工具，注入容器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">PasswordEncoder</span> <span style="color:#000">getPasswordEncoder</span><span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">BCryptPasswordEncoder</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="密码加密">密码加密</h5>
<p>SpringSeurity默认使用PasswordEncoder，要求数据库密码格式：{id}passowrd，根据id判断密码的加密方式。{noop}明文存储</p>
<p>SpringSeurity推荐使用<code>BCryptPasswordEncoder</code>加密方式</p>
<pre tabindex="0"><code>/**
 * SpringSecurity配置类
 * @Author: zq
 * @Date: 2023/08/04/2:14
 * @Description:
 */
@Configuration
@EnableWebSecurity
public class SpringSecurityConfig {
    /*
    * 用户密码工具
    * */
    @Bean
    public PasswordEncoder getPasswordEncoder(){
        return new BCryptPasswordEncoder();
    }
}
</code></pre><h5 id="jwt验证拦截器">JWT验证拦截器</h5>
<pre tabindex="0"><code>/**
 * 访问验证拦截器
 * @Author: zq
 * @Date: 2023/08/04/2:14
 * @Description:
 */
@Component
public class JwtAuthFilter extends OncePerRequestFilter {

    @Autowired
    private RedisTemplate redisTemplate;

    /*
    * 对用户访问资源的HTTP请求头处理
    * */
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws IOException, ServletException {
        // 获取请求头的token
        String token = request.getHeader(&#34;token&#34;);
//        if (!request.getMethod().equals(&#34;OPTIONS&#34;)) {
//            token = request.getHeader(&#34;token&#34;);
//            if (!StringUtils.hasText(token)) {
//                token = request.getParameter(&#34;token&#34;);
//                chain.doFilter(request, response);
//                return;
//            }
//        }
        // token为空,放行=&gt;UsernamePasswordAuthenticationFilter,进行登录验证
        if (!StringUtils.hasText(token)) {
            chain.doFilter(request, response);
            return;
        }


        Claims claims = JwtTokenUtil.parseToken(token);
        // 从token里获取Token Key
        String tokenKey = (String) claims.get(Constants.LOGIN_USER_KEY);
        System.out.println(&#34;tokenKey:&#34; + tokenKey);
        // 根据Token Key从redis获取用户信息
        String redisTokenKey = Constants.LOGIN_TOKENS + tokenKey;
        System.out.println(&#34;redisTokenKey:&#34; + tokenKey);
        LoginUser loginUser = (LoginUser) redisTemplate.opsForValue().get(redisTokenKey);
//        LoginUser loginUser = redisCache.getCacheObject(redisTokenKey);
        // 如果redis找不到，说明用户未登录
        if (Objects.isNull(loginUser)){
            throw new UnauthenticatedException(&#34;用户未登录&#34;);
        }
        // 获取权限信息
        Collection&lt;? extends GrantedAuthority&gt; authorities = loginUser.getAuthorities();
        // 用户主体，凭证，是否已验证(默认true)
        UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(loginUser, null, authorities);
        // 授权失败，token为空
        if (authenticationToken == null){
            chain.doFilter(request,response);
            return;
        }
        // 如果由授权，放到权限上下文中
        // 将权限信息封装到Authentication中
        SecurityContextHolder.getContext().setAuthentication(authenticationToken);
        chain.doFilter(request,response);
    }

}
</code></pre><h5 id="登录服务">登录服务</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 调用authenticate方法进行认证
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#8f5902;font-style:italic">// 认证主体(用户名)、凭证(密码)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">UsernamePasswordAuthenticationToken</span> <span style="color:#000">authenticationToken</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">UsernamePasswordAuthenticationToken</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// AuthenticationManager进行用户认证，该方法会去调用UserDetailsServiceImpl.loadUserByUsername方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">Authentication</span> <span style="color:#000">authenticate</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">authenticationManager</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">authenticate</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">authenticationToken</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">loginUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">LoginUser</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">authenticate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getPrincipal</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// 认证未通过，会抛出异常
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#ce5c00;font-weight:bold">}</span><span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Exception</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">e</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">BadCredentialsException</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">UserPasswordNotMatchException</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="登录接口">登录接口</h5>
<p><a href="https://blog.csdn.net/qq_41340258/article/details/125138902">Spring Security 5.7 最新配置细节（直接就能用），WebSecurityConfigurerAdapter 已废弃_websecurityconfigureradapter作废_江帅帅的博客-CSDN博客</a></p>
<pre tabindex="0"><code>// 接口权限设置
@PreAuthorize(&#34;hasAuthority(&#39;sys:user:list&#39;)&#34;)
hasAnyAuthority()
hasRole()  // ROLE_ + d
</code></pre><h5 id="异常处理">异常处理</h5>
<p>认证或者授权的过程出现异常会被：<code>ExceptionTranslationFilter</code>捕获，在<code>ExceptionTranslationFilter</code>会判断是认证失败还是授权失败出现的异常</p>
<p>认证过程中出现的异常：<code>AuthenticationException</code>然后调用<code>AuthenticationEntryPoint</code>对象的方法去进行异常处理</p>
<p>授权过程中出现的异常：<code>AccessDeniedException</code>然后去调用<code>AccessDeniedHandler</code>对象的方法去进行异常处理</p>
<p>自定义实现类</p>
<p>实现<code>AuthenticationEntryPoint</code>和<code>AccessDeniedHandler</code>两个接口</p>
<pre tabindex="0"><code>
/**
 * 认证失败异常处理
 * @Author: zq
 * @Date: 2023/08/08/13:35
 * @Description:
 */
@Component
public class AuthenticationEntryPointImpl implements AuthenticationEntryPoint {
    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException {
        JsonResult jsonResult = new JsonResult(Constants.UNAUTHORIZED,&#34;用户认证未通过请重新登录&#34;);
        String json = new ObjectMapper().writeValueAsString(jsonResult);
        WebUtils.renderString(response,json);
    }
}
</code></pre><p>配置给SpringSecurity</p>

</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-090ecc4ee4f7bd35e66c63755fc21a6e">Python</h1>
	
	<div class="td-byline mb-4">
		
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-5d8451038365f46f4fe243927b4a9b97">Spring boot</h1>
	
	<div class="td-byline mb-4">
		
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-ec51f207d35e5d80d77970dfc922522f">SSM</h1>
	
	<div class="td-byline mb-4">
		作者: <b>XW</b> |
        
	</div>
	<h1 id="ssm基础知识">SSM基础知识</h1>
<blockquote>
<p>Spring、SpringMVC、Mybatis</p>
</blockquote>
<h2 id="spring">Spring</h2>
<blockquote>
<p>Ioc/DI、AOP、ORM</p>
<p>控制反转/依赖注入、面向切面、对象关系映射</p>
<p><a href="https://www.runoob.com/w3cnote/basic-knowledge-summary-of-spring.html">Spring基础知识汇总 Java开发必看 | 菜鸟教程 (runoob.com)</a></p>
</blockquote>
<h3 id="spring优点">Spring优点</h3>
<ul>
<li>低侵入式设计，代码的污染极低。</li>
<li>独立于各种应用服务器，基于Spring框架的应用，可以真正实现<strong>Write Once，Run Anywhere</strong>的承诺。<strong>(一次编写，随处运行)</strong></li>
<li>Spring的<strong>IoC容器</strong> (控制反转 Inversion of Control) 降低了业务对象替换的复杂性，提高了组件之间的<strong>解耦</strong>。<strong>(自动装配)</strong></li>
<li>Spring的**AOP（面向切面 Aspect Oriented Programming）**支持允许将一些通用任务如安全、事务、日志等进行集中式管理，从而提供了更好的复用。</li>
<li>Spring的<strong>ORM</strong> <strong>(对象关系映射（Object Relational Mapping) <strong>和</strong>DAO</strong>提供了与第三方持久层框架的良好整合，并简化了底层的数据库访问。</li>
<li>Spring的高度开放性，并不强制应用完全依赖于Spring，开发者可自由选用Spring框架的部分或全部。</li>
</ul>
<h3 id="spring框架的组成结构">Spring框架的组成结构</h3>
<p><img src="Spring.assets/673670c9a34075831373b711cb8f21b7.png" alt="SPRING"></p>
<h3 id="spring的核心机制">Spring的核心机制</h3>
<h4 id="管理bean">管理Bean</h4>
<blockquote>
<p>通过<strong>Spring容器</strong>来访问容器中的<code>Bean</code></p>
<p><code>ApplicationContext</code>是<strong>Spring容器</strong>最常用的接口</p>
</blockquote>
<p><code>ApplicationContext</code>接口的实现类</p>
<ul>
<li><code>ClassPathXmlApplicationContext</code>: 从<strong>类加载路径</strong>下搜索<strong>配置文件</strong>，并根据配置文件来创建<strong>Spring容器</strong>。</li>
<li><code>FileSystemXmlApplicationContext</code>: 从<strong>文件系统</strong>的相对路径或绝对路径下去搜索<strong>配置文件</strong>，并根据配置文件来创建<strong>Spring容器</strong>。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">BeanTest</span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">main</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">[])</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ApplicationContext</span> <span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ClassPathXmlApplicationContext</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;beans.xml&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Person</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getBean</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;person&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Person</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">p</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">say</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="依赖注入dependency-injection">依赖注入(Dependency Injection)</h4>
<blockquote>
<p>Ioc/DI（控制反转/依赖注入）</p>
</blockquote>
<p>Spring框架的核心功能有两个：</p>
<ul>
<li>Spring容器作为超级大工厂，<strong>负责创建、管理</strong>所有的<strong>Java对象</strong>，这些Java对象被称为<code>Bean</code>。</li>
<li>Spring容器管理容器中<strong>Bean之间的依赖关系</strong>，Spring使用一种被称为&quot;<strong>依赖注入</strong>&ldquo;的方式来管理Bean之间的依赖关系。</li>
</ul>
<p>使用<strong>依赖注入</strong>，不仅可以为Bean注入<strong>普通的属性值</strong>，还可以注入<strong>其他Bean</strong>的引用。依赖注入是一种优秀的<strong>解耦方式</strong>，其可以让Bean以配置文件组织在一起，而不是以硬编码的方式耦合在一起。</p>
<blockquote>
<p><strong>当某个Java对象（调用者）需要调用另一个Java对象（被依赖对象）的方法时</strong>，在传统模式下通常有两种做法：</p>
</blockquote>
<ol>
<li>原始做法: 调用者<strong>主动</strong>创建被依赖对象**(new 对象)**，然后再调用被依赖对象的方法。</li>
<li>简单工厂模式: 调用者先找到被依赖对象的工厂，然后<strong>主动</strong>通过<strong>工厂</strong>去获取被依赖对象**(Builder模式 见Effective Java阅读笔记第2条)**，最后再调用被依赖对象的方法。</li>
</ol>
<blockquote>
<p><strong>主动创建</strong>会导致调用者与被依赖对象实现类的<strong>硬编码耦合</strong>，非常不利于项目升级的维护</p>
<p>使用Spring后:</p>
<ul>
<li>
<p>调用者获取被依赖对象的方式由原来的<strong>主动</strong>获取，变成了<strong>被动</strong>接受。<strong>(IoC控制反转)</strong></p>
</li>
<li>
<p>Spring容器负责将<strong>被依赖对象</strong>赋值给<strong>调用者的成员变量</strong>——相当于为调用者注入它依赖的实例。<strong>(DI依赖注入)</strong></p>
</li>
</ul>
</blockquote>
<h5 id="设值注入">设值注入</h5>
<blockquote>
<p>设值注入是指<strong>IoC容器</strong>通过<strong>成员变量</strong>的<code>setter</code>方法来注入被依赖对象(Spring依赖注入大量使用)</p>
<p>JavaBean模式</p>
</blockquote>
<h5 id="构造注入">构造注入</h5>
<blockquote>
<p>利用<strong>构造器</strong>来设置依赖关系的方式，被称为构造注入。</p>
<p>Spring在底层以<strong>反射方式</strong>执行带<strong>指定参数的构造器</strong>，当执行带参数的构造器时，就可利用构造器参数对成员变量执行初始化——这就是构造注入的本质。</p>
<p>构造器模式</p>
</blockquote>
<p><strong>注意：</strong>
建议采用<strong>设值注入</strong>为主，<strong>构造注入</strong>为辅的注入策略。对于<strong>依赖关系无须变化</strong>的注入，尽量采用构造注入；而其他依赖关系的注入，则考虑采用设值注入。</p>
<h4 id="spring容器中的bean">Spring容器中的Bean</h4>
<blockquote>
<p><strong>对于开发者来说</strong>，开发者使用Spring框架主要是做两件事：</p>
<p>①开发Bean；②配置Bean。</p>
<p><strong>对于Spring框架来说</strong>，它要做的就是根据<strong>配置文件</strong>来创建<strong>Bean实例</strong>，<strong>并调用Bean实例</strong>的方法完成&quot;依赖注入&rdquo;——这就是所谓<code>IoC</code>的本质。</p>
</blockquote>
<h5 id="容器中bean的作用域">容器中Bean的作用域</h5>
<p>Spring支持如下五种作用域：</p>
<ol>
<li><code>singleton</code>: <strong>单例模式</strong>，在整个Spring IoC容器中，<strong>singleton作用域</strong>的Bean将<strong>只生成一个实例</strong>。（静态）</li>
<li><code>prototype</code>: 每次通过容器的<code>getBean()</code>方法获取<strong>prototype作用域</strong>的Bean时，都将<strong>产生一个新的Bean实例</strong>。(动态)</li>
<li><code>request</code>: <strong>对于一次HTTP请求</strong>，<strong>request作用域</strong>的Bean将<strong>只生成一个实例</strong>，这意味着，在<strong>同一次</strong>HTTP请求<strong>内</strong>，程序每次请求该Bean，得到的总是<strong>同一个实例</strong>。只有在<strong>Web应用</strong>中使用Spring时，该作用域才真正有效。(web应用中生效)</li>
<li><code>session</code>：该作用域将 bean 的定义限制为 <strong>HTTP 会话</strong>。 只在web-aware Spring ApplicationContext的上下文中有效。</li>
<li><code>global session</code>: 每个<strong>全局的HTTP Session</strong>对应<strong>一个Bean实例</strong>。在典型的情况下，仅在使用portlet context的时候有效，同样<strong>只在Web应用中有效</strong>。</li>
</ol>
<blockquote>
<p>如果不指定Bean的作用域，Spring<strong>默认使用singleton作用域</strong>。</p>
<p>prototype作用域的Bean的创建、销毁代价比较大。</p>
<p>而singleton作用域的Bean实例一旦创建成果，就可以重复使用。<strong>因此，应该尽量避免将Bean设置成prototype作用域。</strong></p>
</blockquote>

</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-f97d01fae70ecdf16778c685395fa9b1">日语</h1>
	
	<div class="td-byline mb-4">
		
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-bee76132ef4ff470b1e270563493766f">Spring Cloud</h1>
	
	<div class="td-byline mb-4">
		作者: <b>XW</b> |
        
		<time datetime="2023-07-12" class="text-muted">2023-7-12 23:33:21 周一 下午</time>
        
	</div>
	<h1 id="spring-cloud常用组件">Spring Cloud常用组件</h1>
<p><strong><font color="red">服务的注册和发现。(<code>eureka</code>-netflix,<code>nacos</code>-spring官方,<code>consul</code>-alibaba) </font></strong></p>
<p><strong>服务的负载均衡。(<code>ribbon</code>,<code>dubbo</code>)</strong></p>
<p>服务的相互调用。(<code>openfegin</code>,<code>dubbo</code>)</p>
<p>服务的容错。 (<code>hystrix</code>，<code>sentinel</code>)</p>
<p>服务网关。 (<code>gateway</code>，<code>zuul</code>)</p>
<p>服务配置的统一管理。(<code>config-server</code>,<code>nacos</code>,<code>apollo</code>)</p>
<p>服务消息总线。(<code>bus</code>)</p>
<p>服务安全组件。(<code>security</code>,<code>Oauth2.0</code>)</p>
<p>服务监控。(<code>admin</code>)  (<code>jvm</code>)</p>
<p>链路追踪。(<code>sleuth</code>+<code>zipkin</code>)</p>
<table>
<thead>
<tr>
<th>SpringCloud</th>
<th>spring官方</th>
<th>netflix</th>
<th>alibaba</th>
<th>其它</th>
</tr>
</thead>
<tbody>
<tr>
<td>注册中心</td>
<td>consul</td>
<td><font color="red">eureka</font></td>
<td><font color="red">nacos</font></td>
<td><font color="red">apache/zookeeper</font></td>
</tr>
<tr>
<td>负载均衡</td>
<td></td>
<td><font color="red">ribbon</font></td>
<td>dubbo</td>
<td>GRPC</td>
</tr>
<tr>
<td>远程调用</td>
<td><font color="red">openFeign(集成ribbon)</font></td>
<td></td>
<td>dubbo</td>
<td></td>
</tr>
<tr>
<td>熔断器</td>
<td></td>
<td><font color="red">hystrix</font></td>
<td><font color="red">sentinel</font></td>
<td></td>
</tr>
<tr>
<td>网关</td>
<td><font color="red">gateway</font></td>
<td>zuul</td>
<td>&mdash;&mdash;&mdash;-</td>
<td></td>
</tr>
<tr>
<td>配置文件中心</td>
<td>configServer</td>
<td></td>
<td><font color="red">nacos</font></td>
<td>携程/Apollo</td>
</tr>
<tr>
<td>监控组件</td>
<td><font color="red">admin</font></td>
<td></td>
<td>dubbo-admin</td>
<td></td>
</tr>
<tr>
<td>分布式事务</td>
<td></td>
<td></td>
<td><font color="red">seata</font></td>
<td><font color="red">LCN/TCC/MQ</font></td>
</tr>
<tr>
<td>消息队列</td>
<td>stream</td>
<td></td>
<td><font color="red">rocketMq</font></td>
<td><font color="red">rabbitmq/kafka/activemq</font></td>
</tr>
</tbody>
</table>
<h2 id="微服务">微服务</h2>
<blockquote>
<p>不是一个框架，而是一构建思想。</p>
<p>它时用来描述将如那件应用程序设计为独立部署的服务的一种特殊方式。</p>
<p>微服务构架的系统是个 <strong><font color="red">分布式系统</font></strong>，按业务领域划分为 <strong><font color="red">独立的服务单元</font></strong>，有自动化运维、容错、快速演进的特点，它能够解决传统单体架构系统的痛点，同时也能满足越来越复杂的业务需求</p>
</blockquote>
<h3 id="什么是微服务">什么是微服务？</h3>
<p>就是将一个大的应用，拆分成多个小的模块，每个模块都有自己的功能和职责，每个模块可以进行交互，这就是微服务</p>
<p>“微服务”的发明人，<code>Martin Fowler</code>的理解：</p>
<blockquote>
<p>简而言之，微服务架构的风格，就是将单一程序开发成一个微服务每个微服务运行在自己的进程中，并使用 <font color="red"><strong>轻量级机制通信</strong> </font>，通常是<strong>HTTP RESTFUL API</strong>。
这些服务围绕业务能力来划分构建的，并通过完全自动化部署机制来独立部署这些服务可以使用不同的编程语言，以及不同数据存储技术，以保证最低限度的集中式管理</p>
</blockquote>
<h3 id="微服务的特点">微服务的特点</h3>
<p>优点：</p>
<p>1.按业务(功能)划分为一个独立运行的程序，即服务单元
2.服务之间通过 HTTP 协议相互通信。 http 是一个万能的协议 (web 应用都支持的模式)
3.自动化部署
4.可以用不同的编程语言
5.可以用不同的存储技术
6.服务集中化管理。
7.微服务是一个分布式系统</p>
<p>缺点：</p>
<p>1.微服务的<strong>复杂度</strong>
2.分布式<strong>事务问题</strong>
3.服务的划分(按照<strong>功能</strong>划分 还是按照<strong>组件</strong>来划分呢) 分工</p>
<p>4.服务的<strong>部署</strong>(不用自动化部署 自动化部署)</p>
<h3 id="cicd持续集成持续交付-运维">CI/CD(持续集成/持续交付) 运维</h3>
<blockquote>
<p>微服务的自动化部署，部署多个jar包</p>
</blockquote>
<p>开源软件项目:<code>Jenkins</code></p>
<h3 id="微服务架构的设计原则项目搭建">微服务架构的设计原则(项目搭建)</h3>
<blockquote>
<p><strong>开闭原则 单一原则</strong>  六大设计原则架构设计和代码设计思路一样的</p>
<p>23种设计模式</p>
</blockquote>
<p>在微服务架构中的三大难题：<strong>服务故障的传播性(熔断)、服务的划分和分布式事务</strong>。</p>
<h2 id="spring-cloud">Spring Cloud</h2>
<h3 id="spring-cloud介绍">Spring Cloud介绍</h3>
<p>Spring cloud 作为 Java 语言的微服务框架，它依赖于 Spring Boot，有快速开发、持续交付和容易部署等特点。</p>
<p>开源社区Spring官方和Netflix、Pivotal、alibaba提供支持</p>
<p>Spring cloud 的<strong>首要目标就是通过提供一系列开发组件和框架，帮助开发者迅速搭建一个分布式的微服务系统。</strong></p>
<p>Spring cloud 是通过包装其他技术框架来实现的，例如包装开源的 Netflix oss 组件，实现了一套通过基于注解、 Java 配置和基于模版开发的微服务框架。</p>
<p>spring cloud 提供了开发分布式微服务系统的一些常用组件，例如服务注册和发现、配置中心、熔断器、远程调用，智能路由、微代理、控制总线、全局锁、分布式会话等。</p>
<h3 id="spring-cloud版本对应关系">Spring Cloud版本对应关系</h3>
<p>命名：ABCDE<strong>FGH</strong>I(2020版)</p>
<p>新版本：年份命名</p>
<p><img src="Spring%20Cloud.assets/image-20230713003533882-16891797348915.png" alt="image-20230713003533882"></p>
<p>Spring Cloud和Spring Boot版本对应关系：</p>
<p><a href="https://spring.io/projects/spring-cloud#learn">Spring Cloud</a></p>
<p><a href="https://start.spring.io/actuator/info">start.spring.io/actuator/info</a></p>
<p>Alibaba Spring Cloud支持版本对应：</p>
<p><a href="https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E/662c076ef8f4af0ec94caa86ade169442684904f">版本说明 · alibaba/spring-cloud-alibaba Wiki (github.com)</a></p>
<h3 id="spring-cloud常用组件表">Spring Cloud常用组件表</h3>
<p><strong><font color="red">服务的注册和发现。(<code>eureka</code>-netflix,<code>nacos</code>-spring官方,<code>consul</code>-alibaba) </font></strong></p>
<p><strong>服务的负载均衡。(<code>ribbon</code>,<code>dubbo</code>)</strong></p>
<p>服务的相互调用。(<code>openfegin</code>,<code>dubbo</code>)</p>
<p>服务的容错。 (<code>hystrix</code>，<code>sentinel</code>)</p>
<p>服务网关。 (<code>gateway</code>，<code>zuul</code>)</p>
<p>服务配置的统一管理。(<code>config-server</code>,<code>nacos</code>,<code>apollo</code>)</p>
<p>服务消息总线。(<code>bus</code>)</p>
<p>服务安全组件。(<code>security</code>,Oauth2.0)</p>
<p>服务监控。(<code>admin</code>)  (<code>jvm</code>)</p>
<p>链路追踪。(<code>sleuth</code>+<code>zipkin</code>)</p>
<h4 id="服务的注册和发现eureka">服务的注册和发现(Eureka)</h4>
<blockquote>
<p>注册发现中心
Eureka 来源于古希腊词汇，意为“发现了”。在软件领域，Eureka 是 <strong>Netflix 在线影片公司</strong>开源的一个<strong>服务注册与发现的组件</strong>，和其他Netflix 公司的服务组件 (例如负载均衡熔断器、网关等) 一起，被Spring cloud 社区整合为 <strong>Spring cloud Netflix 模块</strong>。Eureka 是Netflix 贡献给 Spring cloud 的一个框架!</p>
<p>Netflix 给 Spring cloud 贡献了很多框架</p>
</blockquote>
<h5 id="spring-cloud-eureka-和-zookeeper的区别">Spring Cloud Eureka 和 Zookeeper的区别</h5>
<h6 id="什么是-cap-原则面试">什么是 CAP 原则(面试)</h6>
<p>在分布式微服务里面CAP定理
<code>问: 为什么 zookeeper 不适合做注册中心?</code>
CAP 原则又称 CAP 定理，指的是在一个分布式系统中
<strong><font color="red">一致性</font> (Consistency)</strong> :</p>
<p>三个机器中的数据中一致的 <code>C</code>
<strong><font color="red">可用性</font> (Availability)</strong> :</p>
<p>当有一个节点挂掉了整个集群可以继续对外提供服务<code>A</code>
<strong><font color="red">分区容错性</font> (Partition tolerance) (这个特性是不可避免的)</strong></p>
<p>由于机房网络或者分区等原因会导致各个机器中的数据短暂不一致<code>P</code></p>
<p><strong><font color="red">CAP 原则指的是，这三个要素最多只能同时实现两点，不可能三者兼顾</font></strong></p>
<p>CP(数据是一致的但如果有节点挂了，整个服务在几分钟的时间内不能提供服务)</p>
<p>AP(数据可能是不一致的)</p>
<blockquote>
<p>Eureka和Zookeeper区别：</p>
<p>Zookeeper遵循CP原则</p>
<p>Eureka遵循AP原则(高可用)</p>
</blockquote>
<h5 id="搭建一个注册中心">搭建一个注册中心</h5>
<h6 id="eureka-server"><code>eureka-server</code></h6>
<blockquote>
<p>注册中心：可用让别人注册，还可以自己注册自己</p>
</blockquote>
<p>Springboot项目导包：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-server<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>1.<code>pom.xml</code></p>
<blockquote>
<p>springboot和sprincloud版本对应</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-parent<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>2.3.12.RELEASE<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;spring-cloud.version&gt;</span>Hoxton.SR12<span style="color:#204a87;font-weight:bold">&lt;/spring-cloud.version&gt;</span>
</span></span></code></pre></div><p>2.<code>application.properties</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># eureka端口 默认8761</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">server.port</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">8761</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 应用名称 一般：eureka-server</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">spring.application.name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">eureka-server</span>
</span></span></code></pre></div><p>3.<code>EurekaServerApplication</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 开启eureka注册中心的功能
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@EnableEurekaServer</span>
</span></span></code></pre></div><p>启动springboot，访问http://localhost:8761/</p>
<p><img src="Spring%20Cloud.assets/image-20230713142920735-16892297661181.png" alt="image-20230713142920735"></p>
<p>实例ID：localhost:eureka-server:8761</p>
<h6 id="eureka-client-a"><code>eureka-client-a</code></h6>
<blockquote>
<p>客户端a</p>
</blockquote>
<p>Springboot导包：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span> 		<span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>1.<code>pom.xml</code></p>
<blockquote>
<p>springboot和sprincloud版本对应</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-parent<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>2.3.12.RELEASE<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;spring-cloud.version&gt;</span>Hoxton.SR12<span style="color:#204a87;font-weight:bold">&lt;/spring-cloud.version&gt;</span>
</span></span></code></pre></div><p>2.<code>application.properties</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 客户端端口无要求</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">server.port</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">8080</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 应用名称</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">spring.application.name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">eureka-server-a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注册：将信息(ip和port等)发送到注册中心</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定注册地址</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.client.service-url.defaultZone</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">http://localhost:8761/eureka</span>
</span></span></code></pre></div><p>3.<code>EurekaClientAApplication</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 开启客户端的功能
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@EnableEurekaClient</span>
</span></span></code></pre></div><p>启动：</p>
<p><img src="Spring%20Cloud.assets/image-20230713144713741-16892308346772.png" alt="image-20230713144713741"></p>
<p><code>eureka-client-b</code>客户端b</p>
<blockquote>
</blockquote>
<h6 id="配置文件">配置文件</h6>
<blockquote>
<p>eureka三类配置：server client instance</p>
</blockquote>
<p>服务端配置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># eureka端口 默认8761</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">server.port</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">8761</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 应用名称 一般：eureka-server</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">spring.application.name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">eureka-server</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 服务端间隔多少毫秒做定期删除的操作</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.server.eviction-interval-timer-in-ms</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">10000</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 续约百分比</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.server.renewal-percent-threshold</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">0.85</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 主机名称：应用名称：端口号</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.instance.instance-id</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${eureka.instance.hostname}:${eureka.instance.name}:${server.port}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 主机名称/服务IP</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.instance.hostname</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">localhost</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 以IP的形式显示具体的服务信息</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.instance.prefer-ip-address</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 服务实例(eureka-server即使服务端也是客户端)的续约时间间隔</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.instance.lease-renewal-interval-in-seconds</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">5</span>
</span></span></code></pre></div><p>客户端配置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 客户端端口无要求</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">server.port</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">8080</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 应用名称</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">spring.application.name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">eureka-server-a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定注册地址</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.client.service-url.defaultZone</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">http://localhost:8761/eureka</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># eureka-server注册开关</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.client.register-with-eureka</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 应用是否拉去服务列表到本地</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.client.fetch-registry</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为了缓解服务列表的脏读问题，时间越短藏独越少 性能消耗越大</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.client.registry-fetch-interval-seconds</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 应用的主机名称(主机IP)</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.instance.hostname</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">localhost</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.instance.instance-id</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${eureka.instance.hostname}:${spring.application.name}:${server.port}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示IP</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.instance.prefer-ip-address</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 续约时间</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.instance.lease-renewal-interval-in-seconds</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">10</span>
</span></span></code></pre></div><h5 id="高可用的eureka-server集群">高可用的Eureka-Server集群</h5>
<blockquote>
<p>复制配置文件</p>
</blockquote>
<p>集群的方案：中心化集群、主从模式集群、去中心化集群</p>
<h6 id="注册中心集群去中心化集群">注册中心集群（去中心化集群）</h6>
<blockquote>
<p>没有主从概念。eureka会将数据进行广播和扩散**（相互注册）**</p>
</blockquote>
<p><code>eureka-server-A、eureka-server-B、eureka-server-C</code></p>
<blockquote>
<p>应用名称不变</p>
<p>端口 8761、8762、8763</p>
<p>开启注解@EnableEurekaServer</p>
</blockquote>
<p><code>eureka-server-A</code>——<code>application.properties</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认在8761注册</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.client.service-url.defaultZone</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">http://localhost:8762/eureka,http://localhost:8763/eureka</span>
</span></span></code></pre></div><p><code>eureka-server-B</code>——<code>application.properties</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认在8761注册</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.client.service-url.defaultZone</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">http://localhost:8761/eureka,http://localhost:8763/eureka</span>
</span></span></code></pre></div><p><code>eureka-server-C</code>——<code>application.properties</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认在8761注册</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.client.service-url.defaultZone</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">http://localhost:8761/eureka,http://localhost:8762/eureka</span>
</span></span></code></pre></div><p><img src="Spring%20Cloud.assets/image-20230715021754379-16893586759521.png" alt="image-20230715021754379"></p>
<p><img src="Spring%20Cloud.assets/image-20230715022703622-16893592243142.png" alt="image-20230715022703622"></p>
<p>准备三个台服务器，将eureka-server部署到三个不同的服务器里，实现集群。</p>
<p>一台电脑模拟集群，本地修改<code>host</code>文件</p>
<p><code>C:\Windows\System32\drivers\etc\HOSTS</code></p>
<pre tabindex="0"><code>127.0.0.1 peer1
127.0.0.1 peer2
127.0.0.1 peer3
</code></pre><p>虚拟映射地址</p>
<p>修改各自的配置文件<code>application.properties</code>的主机名和注册地址</p>
<p><img src="Spring%20Cloud.assets/image-20230715022822204-16893593033343.png" alt="image-20230715022822204"></p>
<p>客户端修改配置文件<code>application.properties</code>向eureka-server注册</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#c4a000">eureka.client.service-url.defaultZone</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">http://peer1:8761/eureka,http://peer2:8762/eureka,http://peer3:8763/eureka</span>
</span></span></code></pre></div><p><img src="Spring%20Cloud.assets/image-20230715030244727-16893613661814.png" alt="image-20230715030244727"></p>
<h6 id="分布式数据一致性协议paxos-raft主从模式集群">分布式数据一致性协议<code>Paxos</code> <code>raft</code>(主从模式集群)</h6>
<blockquote>
<p>在有主从模式的集群中，遵循这这些协议</p>
<p><a href="http://thesecretlivesofdata.com/raft/">Raft (thesecretlivesofdata.com)</a></p>
</blockquote>
<p>1.数据同步更新</p>
<p>Raft：客户端A将数据1&mdash;-&gt;主节点：服务端A(数据1存放到日志中，未更新节点的值)&mdash;-&gt;副节点：服务端B&hellip;&mdash;-&gt;回应主节点(主节点更新)&mdash;-&gt;副节点更新</p>
<blockquote>
<p>当集群中的大部分节点，都做出了响应时，进行同步</p>
</blockquote>
<p>2.主节点选举</p>
<p>每个节点都有一个随机的苏醒时间，谁先苏醒谁成为候选节点(给自己投一票)，候选节点向其它节点发送投票请求，接收节点未投票则将票投给候选节点，候选节点获得多数票时成为领导者(主节点)</p>
<p>主节点向所有副节点发送心跳（数据同步更新），当主节点宕机后，副节点重新选举。</p>
<blockquote>
<p>当有两个节点同时成为候选节点，则重新洗牌(重置苏醒时间)</p>
</blockquote>
<h5 id="eureka-概念的理解">Eureka 概念的理解</h5>
<ol>
<li>服务的注册
当项目启动时 (<strong>eureka的客户端</strong>)，就会向 <code>eureka-server</code> 发送自己的<strong>元数据 (原始数据)</strong><font color="red">(运行的ip，端口 port，健康的状态监控等，因为使用的是 <code>http/ResuFul</code>请求风格)</font><code>eureka-server</code> 会在<strong>自己内部保留这些元数据</strong>(内存中)。(有一个服务列表) (<code>restful</code> 风格，以http动词(<strong>GET（获取资源）、POST（创建资源）、PUT（更新资源）和DELETE（删除资源）</strong>)的请求方式，完成对url资源的操作)</li>
</ol>
<blockquote>
<p><a href="https://zhuanlan.zhihu.com/p/617187396">一文详解RESTful风格 - 知乎 (zhihu.com)</a></p>
</blockquote>
<ol>
<li>
<p>服务的续约</p>
<p>项目启动成功了，除了向<code>eureka-server</code> 注册自己成功，还会<strong>定时</strong>的向<code>eureka-serve</code>r汇报自己，<strong>心跳</strong>，表示自己还活着。(修改一个时间)</p>
</li>
<li>
<p>服务的下线(主动下线)
当项目关闭时，会给 <code>eureka-server</code> 报告，说明自己要下机了</p>
</li>
<li>
<p>服务的剔除(被动下线，主动剔除)
当项目<strong>超过了指定时间</strong>没有向 <code>eureka-server</code> 汇报自己，那么 <code>eureka-server</code> 就会认为此节点死掉了，会把它剔除掉，也不会放流量和请求到此节点了</p>
</li>
</ol>
<h5 id="eureka注册理解registry">Eureka注册理解registry</h5>
<blockquote>
<p>客户端发送注册请求(<strong>POST</strong>)</p>
<p>服务端接收客户端的注册请求</p>
</blockquote>
<p>保存服务实例数据的集合：</p>
<p>第一个key：应用名称(全大写)</p>
<p>Value中的Map的key：应用实例ID</p>
<p>Value中的Map的Value：具体的服务节点信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">ConcurrentHashMap</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">Map</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">Lease</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">InstanceInfo</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#000">registry</span>
</span></span></code></pre></div><h5 id="eureka续约renew">Eureka续约renew</h5>
<p>客户端发送时间</p>
<p>服务端更新时间（当前时间+续约时间）</p>
<h5 id="eureka剔除">Eureka剔除</h5>
<p>当前时间＞（更新时间+续约时间）</p>
<h5 id="eureka服务发现">Eureka服务发现</h5>
<blockquote>
<p>clientA 通过服务的应用名称(例如：clientB)找到服务的具体实例的过程</p>
</blockquote>
<p>编写Controller发现接口</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">DiscoveryController</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">DiscoveryClient</span> <span style="color:#000">discoveryClient</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;test&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">discovery</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">serverName</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 服务发现
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">ServiceInstance</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">instances</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">discoveryClient</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getInstances</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">serverName</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">instances</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">forEach</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">println</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">instances</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">toString</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>访问接口：<a href="http://localhost:8080/test?serverName=eureka-client-b">localhost:8080/test?serverName=eureka-client-b</a></p>
<p>返回：</p>
<pre tabindex="0"><code>[EurekaDiscoveryClient.EurekaServiceInstance@75bc3ce1 instance = InstanceInfo [instanceId = localhost:eureka-client-b:8081, appName = EUREKA-CLIENT-B, hostName = 192.168.121.1, status = UP, ipAddr = 192.168.121.1, port = 8081, securePort = 443, dataCenterInfo = com.netflix.appinfo.MyDataCenterInfo@4dc123b5]
</code></pre><p>获取IP和端口，即可调用clientB的接口</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">ServiceInstance</span> <span style="color:#000">serviceInstance</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">instances</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">// 获取IP和端口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">String</span> <span style="color:#000">host</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">serviceInstance</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getHost</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">serviceInstance</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getPort</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#4e9a06">&#34;:&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span></code></pre></div><h5 id="docker">Docker</h5>
<p>Eureka-Server服务器(jar包)到Docker镜像部署</p>
<p><code>eureka-server-1.0.jar</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#c4a000">eureka.client.service-url.defaultZone</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${EUREKA_SERVER_URL:http://peer1:8761/eureka}</span>
</span></span><span style="display:flex;"><span><span style="color:#c4a000">eureka.client.register-with-eureka</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${REGISTER_WITH_EUREKA:true}</span>
</span></span></code></pre></div><pre tabindex="0"><code>mkdir eureka-server
cd eureka-server
pwd
# 获取路径workdir
</code></pre><p><code>Dockerfile</code></p>
<pre tabindex="0"><code>FROM openjdk:8
# 环境变量
ENV workdir=/PAYH
# 将当前目录拷贝到workdir
COPY . ${workdir}
# 切换到workdir
WORKDIR ${workdir}
# 端口
EXPOSE 8761
CMD [&#34;java&#34;,&#34;-jar&#34;,&#34;eureka-server.jar&#34;]
</code></pre><p>run.sh</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 基于文件夹 -t:tag</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> .. <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> docker build ./eureka-server -t eureka-server:1.0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chmod <span style="color:#0000cf;font-weight:bold">777</span> run.sh
</span></span><span style="display:flex;"><span>./run.sh
</span></span><span style="display:flex;"><span>doucker run --name eureka-server -p 8761:8761 -e <span style="color:#000">REGISTER_WITH_EUREKA</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span> -d eureka-server:1.0
</span></span><span style="display:flex;"><span>docker logs eureka-server
</span></span></code></pre></div><p><code>run -p 端口 -d 后台运行(守护) --link 指定网络host文件映射的 -e REGISTER_WITH_EUREKA=false(指定参数) -v 文件挂载</code></p>
<h5 id="resttemplate使用">restTemplate使用</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.projectlombok<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>lombok<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;optional&gt;</span>true<span style="color:#204a87;font-weight:bold">&lt;/optional&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>编写测试接口</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">TestController</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;testGet&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;ok&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * post接收参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 1.json数据
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * header content-type=application/json
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @RequestBody User user
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 加注解
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 2.表单数据
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * header content-type=x-www-form-undercode
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * User user
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 不加注解
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;testPost&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">testPost</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestBody</span> <span style="color:#000">User</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;ok&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;testPost2&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">testPost2</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">User</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;ok&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>使用restTemplate发起请求</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testGet</span><span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">RestTemplate</span> <span style="color:#000">restTemplate</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RestTemplate</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">String</span> <span style="color:#000">url</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;http://localhost:8080/testGet?name=zq&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">String</span> <span style="color:#000">object</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">restTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getForObject</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">url</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">object</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testGet2</span><span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">RestTemplate</span> <span style="color:#000">restTemplate</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RestTemplate</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">String</span> <span style="color:#000">url</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;http://localhost:8080/testGet?name=zq&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ResponseEntity</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">responseEntity</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">restTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getForEntity</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">url</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// http:// 协议(规范,接头暗号)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// 包含：请求头、请求参数、响应头、响应状态码、报文等。。。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">responseEntity</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// &lt;200,ok,[Content-Type:&#34;text/plain;charset=UTF-8&#34;, Content-Length:&#34;2&#34;, Date:&#34;Sun, 16 Jul 2023 18:36:25 GMT&#34;, Keep-Alive:&#34;timeout=60&#34;, Connection:&#34;keep-alive&#34;]&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 表单参数传参
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#5c35cc;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">testPost2</span><span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">RestTemplate</span> <span style="color:#000">restTemplate</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RestTemplate</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">String</span> <span style="color:#000">url</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;http://localhost:8080/testPost2&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 构建表单参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">LinkedMultiValueMap</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Object</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">map</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">LinkedMultiValueMap</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">map</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#4e9a06">&#34;zq&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">map</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;age&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">String</span> <span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">restTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">postForObject</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">url</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">map</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="客户端负载均衡工具ribbon">客户端负载均衡工具(Ribbon)</h4>
<blockquote>
<p>Spring Cloud Ribbon是一个基于HTTP和TCP的客户端<strong>负载均衡</strong>工具</p>
<p>将面向服务的REST模板请求自动转换成客户端负载均衡的服务调用</p>
<p>负载均衡的算法：轮询(请求次数 % 机器数量)、iphash、权重、随机</p>
<p>响应时间最短轮询、并发量最小轮询、过滤出符合条件的轮询、区域内亲和轮询算法</p>
<p>Ribbon是netfix公司的一个开源项目，主要功能：<strong>提供客户端负载均衡算法和服务调用</strong></p>
<p>两种方法结合使用：</p>
<ol>
<li>
<p>RestTemplate</p>
</li>
<li>
<p>Openfegin</p>
</li>
</ol>
</blockquote>
<p>负载均衡</p>
<blockquote>
<p>Load Balance(LB)</p>
<p>http://（http协议）</p>
<p>lb://（负载均衡协议）</p>
<p>将负载（工作任务）进行平衡、分摊到 多个操作单元上进行运行</p>
</blockquote>
<h5 id="ribbon的使用">Ribbon的使用</h5>
<blockquote>
<p>先启动提供者，再启动消费者（不然消费者会先拉去注册中心的服务信息，没有启动者的服务信息）</p>
</blockquote>
<p><code>provider</code> <code>provider-b</code> 接口提供者</p>
<blockquote>
<p>eureka客户端</p>
</blockquote>
<p><img src="Spring%20Cloud.assets/image-20230725132719884-16902628418271.png" alt="image-20230725132719884"></p>
<p><code>application.yml</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 集群，端口不同</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 应用名一样</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spring</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">provider</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">eureka</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">client</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">service-url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">defaultZone</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://localhost:8761/eureka</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">instance</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">hostname</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">localhost</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">prefer-ip-address</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">instance-id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${eureka.instance.hostname}:${spring.application.name}:${server.port}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>ProviderController.java</code> 提供同样的接口</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ProviderController</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">hello</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;provider的接口&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>consumer</code> 接口消费者，用户，使用ribbon达到负载均衡的效果</p>
<p><code>application.yml</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 集群，端口不同</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8082</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 应用名一样</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spring</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">consumer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">eureka</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">client</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">service-url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">defaultZone</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://localhost:8761/eureka</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">instance</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">hostname</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">localhost</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">prefer-ip-address</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">instance-id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${eureka.instance.hostname}:${spring.application.name}:${server.port}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>将<code>restTemplate</code>给<code>springboot</code>和<code>ribbon</code>托管</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@LoadBalanced</span> <span style="color:#8f5902;font-style:italic">// 被ribbon接管
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">RestTemplate</span> <span style="color:#000">restTemplate</span><span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RestTemplate</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>ConsumerController.java</code> 测试接口，使用服务名进行调用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ConsumerController</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 自动装配
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">RestTemplate</span> <span style="color:#000">restTemplate</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * ribbon
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 1.拦截这个请求
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 2.截取主机名称 serverName
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 3.借助eureka来做服务发现  List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(serverName);
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 4.通过负载均衡算法，拿其中一个服务ip,port
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 5.reConstructURL 重构地址( http://localhost:8080/hello)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 6.发起请求
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @param serviceName
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;testRibbon&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">testRibbon</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">serviceName</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 根据服务名来调用，不需要写端口号，ribbon帮忙负载均衡，默认算法：轮询
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// http://provider/hello
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">String</span> <span style="color:#000">object</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">restTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getForObject</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http://&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">serviceName</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;/hello&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">object</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="负载均衡和远程调用">负载均衡和远程调用</h5>
<blockquote>
<p>访问不同的服务，可以使用不同的算法规则</p>
<p><code>shift+shift</code>查询<code>IRule</code>算法接口 ,实现接口可自定义算法</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 自定义的负载均衡算法</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">provider</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 提供者的服务名称</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ribbon</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">NFLoadBalancerRuleClassName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">com.netflix.loadbalancer.RandomRule</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 几种算法的全限定类名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 提供者算法全局变量，自定义算法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">IRule</span> <span style="color:#000">myRule</span><span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RandomRule</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="ribbon默认的配置类defaultclientconfigimpl">Ribbon默认的配置类：DefaultClientConfigImpl</h5>
<pre tabindex="0"><code class="language-YML" data-lang="YML">ribbon:
  eureka:
    enabled: true   # 开启eureka支持
  eager-load:
    enabled: false   # 加载模式 第一次访问的时候(false)或者第一次启动的时间(true)访问eureka服务列表
  http:   # ribbon使用restTemplate封装了java.net.HttpUrlConnection发送的请求(不支持连接池)
    client:   # 发送请求的工具有很多 httpClient(支持连接池) 添加依赖(使用其它工具)
      enabled: false
  okhttp:   # 也是请求工具，在移动端用的多
    enabled: false
</code></pre><p>总结：</p>
<blockquote>
<p>ILoadBalancer接口：</p>
<p>从eureka拉取服务列表，使用IRule算法实现客户端调用的负载均衡</p>
</blockquote>
<h4 id="声明式注解web服务客户端openfegin">声明式(注解)web服务客户端(Openfegin)</h4>
<blockquote>
<p><strong>是完成服务之间调用的组件</strong>(远程调用的组件)http调用</p>
<p>使用fegin创建一个接口并进行注解(包含：fegin和JAX-RS注解)</p>
<p>还支持可热拔编码器和解码器。</p>
<p><code>fegin</code>集成了<code>Ribbon</code>(Ribbon集成了eureka)</p>
</blockquote>
<blockquote>
<p>微服务思想：<strong>我不会，别人会，我去调用别人</strong></p>
<p>前端——》user-sevice(/userOrder)——》RPC(fegin远程过程调用HTTP协议通信)——》order-service(/doOrder)</p>
<p>fegin默认等待时间为1s</p>
<p>超过1s报错超时</p>
</blockquote>
<pre tabindex="0"><code>Whitelabel Error Page
This application has no explicit mapping for /error, so you are seeing this as a fallback.

Wed Jul 26 23:10:29 CST 2023
There was an unexpected error (type=Internal Server Error, status=500).
</code></pre><p>配置fegin超时时间</p>
<h5 id="order-service"><code>order-service</code></h5>
<p><code>pom.xml</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.projectlombok<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>lombok<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;optional&gt;</span>true<span style="color:#204a87;font-weight:bold">&lt;/optional&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><code>application.yml</code></p>
<pre tabindex="0"><code class="language-YML" data-lang="YML">server:
  port: 8080
spring:
  application:
    name: order-service
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka
</code></pre><p><code>OrderController.java</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">OrderController</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;doOrder&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">doOrder</span><span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;订单-01麻辣香锅&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="user-service"><code>user-service</code></h5>
<blockquote>
<p>开启fegin的客户端功能 才可以发送远程调用</p>
<p>@EnablefeginClients</p>
</blockquote>
<p><code>UserServiceApplication</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@EnableEurekaClient</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@EnablefeginClients</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UserServiceApplication</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">main</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">SpringApplication</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">run</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">UserServiceApplication</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>pom.xml</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-cloud-starter-openfegin<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.projectlombok<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>lombok<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;optional&gt;</span>true<span style="color:#204a87;font-weight:bold">&lt;/optional&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><code>application.yml</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8081</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spring</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">user-service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">eureka</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">client</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">service-url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">defaultZone</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://localhost:8761/eureka</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>UserController</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UserController</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 动态代理 jdk(java interface 接口 $Proxy) /cglib(subClass 子类)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * jdk动态代理 只要是代理对象调用的方法必须走invoke方法(InvocationHandler类里的)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * java.lang.reflect.InvocationHandler#invoke(java.lang.Object, java.lang.reflect.Method, java.lang.Object[])
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     *                       (代理对象,调用方法,调用方法参数)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     *  public Object invoke(Object proxy, Method method, Object[] args)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">UserOrderfegin</span> <span style="color:#000">userOrderfegin</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;userOrder&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">userOrder</span><span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;用户下单&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 发起远程调用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">String</span> <span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">userOrderfegin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">doOrder</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">s</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>fegin/UserOrderfegin.java</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// User模块调用Order模块的fegin
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// value = &#34;order-service&#34; 服务提供者的应用名称
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@feginClient</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;order-service&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">UserOrderfegin</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 需要调用哪个接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     *     写方法签名：
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     *     (注解)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     *     @GetMapping(&#34;doOrder&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     *     (修饰符 返回值 方法名 方法参数)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     *     public String doOrder();
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;doOrder&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">doOrder</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="fegin原理">fegin原理</h5>
<blockquote>
<p>jdk动态代理 + ribbon + restTemplate</p>
<p>使用代理拦截方法，获取方法上的<code>GetMapping</code>注解的值(接口)</p>
<p>获取类上的<code>feginClient</code>注解的值(应用名)</p>
<p>拼接调用地址http://applicationName/api</p>
<p>使用ribbon远程调用</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@SpringBootTest</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UserServiceApplicationTests</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">RestTemplate</span> <span style="color:#000">restTemplate</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">contextLoads</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">UserOrderfegin</span> <span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">UserOrderfegin</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">Proxy</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">newProxyInstance</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">UserController</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getClassLoader</span><span style="color:#ce5c00;font-weight:bold">(),</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Class</span><span style="color:#ce5c00;font-weight:bold">[]{</span><span style="color:#000">UserOrderfegin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">InvocationHandler</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Object</span> <span style="color:#000">invoke</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Object</span> <span style="color:#000">proxy</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Method</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Object</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Throwable</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// 服务发现，拿到ip、port和方法注解的值value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">String</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getName</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// 获取GetMapping注解的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">GetMapping</span> <span style="color:#000">annotation</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">GetMapping</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">annotation</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">value</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// 获取第一个值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">String</span> <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// 获取声明类
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">Class</span><span style="color:#ce5c00;font-weight:bold">&lt;?&gt;</span> <span style="color:#000">aClass</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">method</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getDeclaringClass</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// 获取类的名字
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">String</span> <span style="color:#000">name1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">aClass</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getName</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// 获取声明类的feginClient注解
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">feginClient</span> <span style="color:#000">annotation1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">aClass</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAnnotation</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">feginClient</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// 获取feginClient注解的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">String</span> <span style="color:#000">applicationName</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">annotation1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">value</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">String</span> <span style="color:#000">url</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;http://&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">applicationName</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// 发送远程调用(ribbon使用),不需要端口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">String</span> <span style="color:#000">forObject</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">restTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getForObject</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">url</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">forObject</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">String</span> <span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">o</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">doOrder</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="fegin开发重点">fegin开发重点</h5>
<blockquote>
<p>消费者 和 提供者 的参数列表 一致(传参数) 返回值、方法签名一致</p>
<ol>
<li>URL传参数(<code>testUrl/{name}/add/{age}</code>)，GET请求 参数列表使用 @PathVariable(&quot;&quot;)</li>
<li>GET请求(<code>?value=</code>)，每个基本参数必须加 @RequestParam(&quot;&quot;)</li>
<li>POST请求，传对象、集合等参数，必须加@Requestbody <code>请求体</code>或 @RequestParam <code>表单</code></li>
</ol>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@Data</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@AllArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@NoArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@Builder</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Order</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Integer</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Double</span> <span style="color:#000">price</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">Date</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>提供者 不同传参接口</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * URL传参 /doOrder2/麻辣香锅/add/可乐/
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * GET传递一个参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * GET传递多个参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * POST传递一个对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * POST传递一个对象+一个基本参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * POST传递两个对象(封装) https://zhuanlan.zhihu.com/p/102389552
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;testUrl/{name}/add/{age}&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">testUrl</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@PathVariable</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#5c35cc;font-weight:bold">@PathVariable</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;age&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000">Integer</span> <span style="color:#000">age</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#4e9a06">&#34;:&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">age</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;ok&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;oneParam&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">oneParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">required</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;ok&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;twoParam&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">twoParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">required</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">required</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">Integer</span> <span style="color:#000">age</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">age</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;ok&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;oneObject&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">oneObject</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestBody</span> <span style="color:#000">Order</span> <span style="color:#000">order</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">order</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;ok&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;oneObjectAndParam&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">oneObjectAndParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestBody</span> <span style="color:#000">Order</span> <span style="color:#000">order</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span> <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">order</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;ok&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>消费者</p>
<p>使用fegin远程调用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// User模块调用Order模块的fegin
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// value = &#34;order-service&#34; 服务提供者的应用名称
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@feginClient</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;order-service&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">UserOrderfegin</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 需要调用哪个接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     *     写方法签名：
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     *     (注解)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     *     @GetMapping(&#34;doOrder&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     *     (修饰符 返回值 方法名 方法参数)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     *     public String doOrder();
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;doOrder&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">String</span> <span style="color:#000">doOrder</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;testUrl/{name}/add/{age}&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">String</span> <span style="color:#000">testUrl</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@PathVariable</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#5c35cc;font-weight:bold">@PathVariable</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;age&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000">Integer</span> <span style="color:#000">age</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;oneParam&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">String</span> <span style="color:#000">oneParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">required</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;twoParam&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">String</span> <span style="color:#000">twoParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">required</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">required</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">Integer</span> <span style="color:#000">age</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;oneObject&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">String</span> <span style="color:#000">oneObject</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestBody</span> <span style="color:#000">Order</span> <span style="color:#000">order</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@PostMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;oneObjectAndParam&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">String</span> <span style="color:#000">oneObjectAndParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestBody</span> <span style="color:#000">Order</span> <span style="color:#000">order</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span> <span style="color:#000">String</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 测试接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;testParam&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">testParam</span><span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">String</span> <span style="color:#000">zq</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">userOrderfegin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">testUrl</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;zq&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">zq</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">String</span> <span style="color:#000">oneParam</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">userOrderfegin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">oneParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;zq1&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">oneParam</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">String</span> <span style="color:#000">twoParam</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">userOrderfegin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">twoParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;zq2&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">twoParam</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Order</span> <span style="color:#000">order</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Order</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">builder</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">name</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;麻辣香锅&#34;</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">price</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">188</span><span style="color:#000">D</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">time</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Date</span><span style="color:#ce5c00;font-weight:bold">()).</span><span style="color:#c4a000">id</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">String</span> <span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">userOrderfegin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">oneObject</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">order</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">String</span> <span style="color:#000">oneObjectAndParam</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">userOrderfegin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">oneObjectAndParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">order</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;zq&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">oneObjectAndParam</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;OK&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>时间传参问题</p>
<p>消费者测试接口</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>   <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 1.单独传送时间参数，会差10个小时
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 2.转成字符串即可 或
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 3.使用jdk的时间类型 LocalDate(年月日) LocalDateTime(时分秒)会丢失秒s
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 4.改fegin的源码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;time&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Date</span> <span style="color:#000">date</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Date</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 年月日
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">LocalDate</span> <span style="color:#000">now</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LocalDate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">now</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 时分秒
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">LocalDateTime</span> <span style="color:#000">dateTime</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LocalDateTime</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">now</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">date</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Thu Jul 27 12:48:32 CST 2023
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">String</span> <span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">userOrderfegin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">testTime</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">date</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Fri Jul 28 02:48:32 CST 2023
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">s</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>fegin/UserOrderfegin</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;testTime&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">testTime</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span> <span style="color:#000">Date</span> <span style="color:#000">date</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span></code></pre></div><p><code>OrderController.java </code>提供者接口</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 传时间
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;testTime&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">testTime</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span> <span style="color:#000">Date</span> <span style="color:#000">date</span><span style="color:#ce5c00;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">date</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;ok&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h5 id="fegin调用状态码">fegin调用状态码</h5>
<blockquote>
<p>fegin包的Client接口108行</p>
<p><code>HttpStatus.java</code>(所有状态码)</p>
</blockquote>
<p>200 成功</p>
<p>400 请求参数错误</p>
<p>401 没有权限</p>
<p>403 权限不够</p>
<p>404 路径不匹配</p>
<p>405 方法不允许</p>
<p>500 提供者报错了</p>
<p>302 资源重定向</p>
<h5 id="fegin日志">fegin日志</h5>
<blockquote>
<p>Level(日志等级)</p>
<p>接口请求时间500毫秒/300毫秒 合理</p>
<pre tabindex="0"><code>public static enum Level {
        NONE,
        BASIC,
        HEADERS,
        FULL;

        private Level() {
        }
    }
</code></pre></blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * feign
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 打印日志信息 级别
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Logger</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">Level</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Logger</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">Level</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">BASIC</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">logging</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">level</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">com.zq.userservice.feign.UserOrderFeign</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">debug</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 打印这个接口下面的日志</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h4 id="熔断器hystrix">熔断器(Hystrix)</h4>
<blockquote>
<p><strong>服务雪崩</strong></p>
<p>核心本质：线程没有及时回收</p>
<p>熔断：直接return，业务不能完成，但是可以缓解服务器压力</p>
<p>解决方案：</p>
<ol>
<li>调整等待时间，可缓解解压，有局限性(有的服务需要多的时间去执行)</li>
<li>在上游服务知道下游服务的状态，下游服务OK，正常发请求；宕机，则直接return，不发请求。</li>
<li>设置备选方案</li>
</ol>
<p>链式调用：A服务——》B服务——》C服务(挂了)</p>
<ol>
<li>用户请求A服务，A服务tomcat分配一个线程支持用户的访问。A服务发现需要完成用户的操作，需要调用B服务</li>
<li>A服务请求B服务，B服务tomcat分配一个线程支持A服务的访问，B服务发现需要完成用户的操作，需要调用C服务</li>
<li>B服务调用C服务，C服务宕机了，B并不知道。导致A和B的线程没有回收，此时大量请求进入A服务或者B服务，AB会报503 service unavailable</li>
</ol>
</blockquote>
<p>在分布式的链路中，只要有一个服务宕机，可能导致整个业务线都瘫痪。</p>
<blockquote>
<p>Hystrix(Netflx)</p>
<p><strong>用来保护微服务不雪崩的方法</strong>。</p>
<p><strong>能够阻止分布式系统中出现联动故障.</strong></p>
<p>通过隔离服务的访问点阻止联动故障，并提供了故障的解决方案，从而提高整个分布式系统的弹性。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spring</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">customer-service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">eureka</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">client</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">service-url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">defaultZone</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://localhost:8761/eureka</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">instance</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">hostname</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">localhost</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">instance-id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${eureka.instance.hostname}:${spring.application.name}:${server.port}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">feign</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hystrix</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">enabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 在F版以上默认开启</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#  circuitbreaker:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    enabled: true   # cloud2020以上的配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h4 id="customer-service-消费者"><code>customer-service </code>消费者</h4>
<p><code>pom.xml</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><code>feign/CustomerRentFeign.java</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 指定熔断的类，fallback = 失败回调的类
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#5c35cc;font-weight:bold">@FeignClient</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;rent-car-service&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">fallback</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">CustomerRentFeignHystrix</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">CustomerRentFeign</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;rent&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">rent</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>feign/hystrix/CustomerRentFeignHystrix.java</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@Component</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">CustomerRentFeignHystrix</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">CustomerRentFeign</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 备选方案
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">String</span> <span style="color:#000">rent</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;备选方案&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="rent-car-service提供者"><code>rent-car-service</code>提供者</h4>
<p><code>pom.xml</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h4 id="断路器状态机制">断路器状态机制</h4>
<blockquote>
<p>关：默认情况下关闭，正常调用服务</p>
<p>开：尝试调用服务，在一个时间窗口(10s)内，多次访问，失败次数达到一个阈值，认为拓机了，启动备选方案</p>
<p>半开：让少许流量去尝试调用，如果正常了，就关掉断路器</p>
<p>关——》开——》半开——》关</p>
</blockquote>
<p><code>hystrix/spare</code>手写断路器代码</p>
<h3 id="spring-cloud实现方案">Spring Cloud实现方案</h3>
<blockquote>
<p>SpringCloud 就是微服务理念的一种<strong>具体落地实现方式</strong></p>
</blockquote>
<p>Dubbo+Zookeeper 半自动化的微服务实现架构</p>
<p>SpringCloud Netflix 一站式微服务架构</p>
<p>SpringCloud Alibaba 新的一站式微服务架构</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-dc25dce949429781efd35f25490c266c">Docker</h1>
	
	<div class="td-byline mb-4">
		作者: <b>XW</b> |
        
	</div>
	<h1 id="容器container">容器(Container)</h1>
<blockquote>
<p>应用程序在运行时相互独立互不干扰</p>
<p>只隔离应用程序的运行时环境，容器之间可以共享同一个操作系统</p>
<p>类似码头(主机)和集装箱(容器)</p>
</blockquote>
<h2 id="docker">Docker</h2>
<blockquote>
<p>Docker 是一个开源的应用容器引擎，基于 <a href="https://www.runoob.com/go/go-tutorial.html">Go 语言</a> 并遵从 Apache2.0 协议开源。</p>
<p>Docker 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。</p>
<p>容器是完全使用沙箱机制，相互之间不会有任何接口（类似 iPhone 的 app）,更重要的是容器性能开销极低。</p>
<p><a href="https://docs.docker.com/">Docker Docs: How to build, share, and run applications | Docker Documentation</a></p>
</blockquote>
<p><img src="https://docs.docker.com/assets/images/architecture.svg" alt="docker"></p>
<h3 id="名词概念">名词概念</h3>
<p><code>dockerfile(源码/配置文件)</code></p>
<p><code>image(镜像/可执行程序/类)</code></p>
<p><code>container(容器/进程/对象)</code></p>
<p><code>registry(容器仓库)</code> <a href="%5Bhttps://hub.docker.com%5D(https://hub.docker.com/)">Docker Hub</a></p>
<p><code>docker client(负责处理用户输入的指令/client)</code></p>
<p><code>docker demon(服务器)</code></p>
<table>
<thead>
<tr>
<th style="text-align:left">概念</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Docker 镜像(Images)</td>
<td style="text-align:left">Docker 镜像是用于创建 Docker 容器的模板，比如 Ubuntu 系统。</td>
</tr>
<tr>
<td style="text-align:left">Docker 容器(Container)</td>
<td style="text-align:left">容器是独立运行的一个或一组应用，是镜像运行时的实体。</td>
</tr>
<tr>
<td style="text-align:left">Docker 客户端(Client)</td>
<td style="text-align:left">Docker 客户端通过命令行或者其他工具使用 Docker SDK (<a href="https://docs.docker.com/develop/sdk/">https://docs.docker.com/develop/sdk/</a>) 与 Docker 的守护进程通信。</td>
</tr>
<tr>
<td style="text-align:left">Docker 主机(Host)</td>
<td style="text-align:left">一个物理或者虚拟的机器用于执行 Docker 守护进程和容器。</td>
</tr>
<tr>
<td style="text-align:left">Docker Registry</td>
<td style="text-align:left">Docker 仓库用来保存镜像，可以理解为代码控制中的代码仓库。Docker Hub(<a href="https://hub.docker.com/">https://hub.docker.com</a>) 提供了庞大的镜像集合供使用。一个 Docker Registry 中可以包含多个仓库（Repository）；每个仓库可以包含多个标签（Tag）；每个标签对应一个镜像。通常，一个仓库会包含同一个软件不同版本的镜像，而标签就常用于对应该软件的各个版本。我们可以通过 <strong>&lt;仓库名&gt;:&lt;标签&gt;</strong> 的格式来指定具体是这个软件哪个版本的镜像。如果不给出标签，将以 <strong>latest</strong> 作为默认标签。</td>
</tr>
<tr>
<td style="text-align:left">Docker Machine</td>
<td style="text-align:left">Docker Machine是一个简化Docker安装的命令行工具，通过一个简单的命令行即可在相应的平台上安装Docker，比如VirtualBox、 Digital Ocean、Microsoft Azure。</td>
</tr>
</tbody>
</table>
<h3 id="常用指令">常用指令</h3>
<table>
<thead>
<tr>
<th>docker client</th>
<th>docker demon</th>
<th>Registry</th>
</tr>
</thead>
<tbody>
<tr>
<td>docker build(编译)</td>
<td>dockerfile-&gt;image</td>
<td></td>
</tr>
<tr>
<td>docker run(运行)</td>
<td>image-&gt;container</td>
<td></td>
</tr>
<tr>
<td>docker pull(下载镜像)</td>
<td></td>
<td>image</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动服务</span>
</span></span><span style="display:flex;"><span>systemctl start docker
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># exit或CTRL+D退出容器</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看出本地主机上的所有镜像</span>
</span></span><span style="display:flex;"><span>docker images
</span></span></code></pre></div><blockquote>
<p>同一仓库源可以有多个 TAG，代表这个仓库源的不同个版本，如 ubuntu 仓库源里，有 15.10、14.04 等多个不同的版本，我们使用 <code>REPOSITORY:TAG</code> 来定义<strong>不同的镜像</strong>。</p>
</blockquote>
<p>各个选项说明:</p>
<ul>
<li>**<code>REPOSITORY</code>：**表示镜像的仓库源</li>
<li>**<code>TAG</code>：**镜像的标签</li>
<li>**<code>IMAGE ID</code>：**镜像ID</li>
<li>**<code>CREATED</code>：**镜像创建时间</li>
<li>**<code>SIZE</code>：**镜像大小</li>
</ul>
<h4 id="运行交互式的容器">运行交互式的容器</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run -i -t <span style="color:#ce5c00;font-weight:bold">[</span>指定运行的镜像<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>启动容器执行的命令<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>docker run -it <span style="color:#ce5c00;font-weight:bold">[</span>指定运行的镜像<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>启动容器执行的命令<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>参数：</p>
<ul>
<li><code>-t</code>: 在新容器内指定一个伪终端或终端。</li>
<li><code>-i</code>: 允许你对容器内的标准输入 (STDIN) 进行交互。</li>
</ul>
<h4 id="进程方式运行的容器">进程方式运行的容器</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run -d <span style="color:#ce5c00;font-weight:bold">[</span>指定运行的镜像<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>启动容器执行的命令<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看容器运行的进程</span>
</span></span><span style="display:flex;"><span>docker ps
</span></span><span style="display:flex;"><span>docker ps -a
</span></span></code></pre></div><p>输出详情介绍：</p>
<ul>
<li>
<p><strong><code>CONTAINER ID</code>:</strong> 容器 ID。</p>
</li>
<li>
<p><strong><code>IMAGE</code>:</strong> 使用的镜像。</p>
</li>
<li>
<p><strong><code>COMMAND</code>:</strong> 启动容器时运行的命令。</p>
</li>
<li>
<p><strong><code>CREATED:</code></strong> 容器的创建时间。</p>
</li>
<li>
<p><strong><code>STATUS</code>:</strong> 容器状态。</p>
<ul>
<li>状态有7种：
<ul>
<li><code>created</code>（已创建）</li>
<li><code>restarting</code>（重启中）</li>
<li><code>running</code> 或 <code>Up</code>（运行中）</li>
<li><code>removing</code>（迁移中）</li>
<li><code>paused</code>（暂停）</li>
<li><code>exited</code>（停止）</li>
<li><code>dead</code>（死亡）</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong><code>PORTS</code>:</strong> 容器的端口信息和使用的连接类型（tcp\udp）。</p>
</li>
<li>
<p><strong><code>NAMES</code>:</strong> 自动分配的容器名称。</p>
</li>
</ul>
<h4 id="查看容器内的标准输出">查看容器内的标准输出</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker logs <span style="color:#ce5c00;font-weight:bold">[</span>CONTAINER ID<span style="color:#ce5c00;font-weight:bold">]</span>/<span style="color:#ce5c00;font-weight:bold">[</span>NAMES<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h3 id="镜像">镜像</h3>
<h4 id="查找镜像">查找镜像</h4>
<blockquote>
<p><a href="https://hub.docker.com/">https://hub.docker.com/</a></p>
</blockquote>
<pre tabindex="0"><code>docker search [镜像]
</code></pre><ul>
<li><strong><code>NAME</code>:</strong> 镜像仓库源的名称</li>
<li><strong><code>DESCRIPTION</code>:</strong> 镜像的描述</li>
<li><strong><code>OFFICIAL</code>:</strong> 是否 docker 官方发布</li>
<li><strong><code>stars</code>:</strong> 类似 Github 里面的 star，表示点赞、喜欢的意思。</li>
<li><strong><code>AUTOMATED</code>:</strong> 自动构建。</li>
</ul>
<h4 id="获取镜像">获取镜像</h4>
<pre tabindex="0"><code>docker pull [镜像]
</code></pre><h4 id="创建镜像">创建镜像</h4>
<h5 id="更新镜像">更新镜像</h5>
<blockquote>
<p>先创建一个容器<code>docker run -it</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在容器内</span>
</span></span><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span><span style="color:#204a87">exit</span>
</span></span></code></pre></div><h5 id="修改容器">修改容器</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker commit -m<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;has update&#34;</span> -a<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;runoob&#34;</span> <span style="color:#ce5c00;font-weight:bold">[</span>CONTAINER ID<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>NAMES<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>docker commit -m<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;has update&#34;</span> -a<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;runoob&#34;</span> e218edb10161 runoob/ubuntu:v2
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看新的镜像</span>
</span></span><span style="display:flex;"><span>docker images
</span></span></code></pre></div><p>参数说明：</p>
<ul>
<li><strong><code>-m</code>:</strong> 提交的描述信息</li>
<li><strong><code>-a</code>:</strong> 指定镜像作者</li>
<li>**e218edb10161：**容器 ID</li>
<li><strong>runoob/ubuntu:v2:</strong> 指定要创建的目标镜像名</li>
</ul>
<h5 id="构建镜像">构建镜像</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建文件</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span>cat Dockerfile<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06">    centos:6.7</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">MAINTAINER</span><span style="color:#4e9a06">      Fisher &#34;fisher@sudops.com&#34;</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span>     /bin/echo <span style="color:#4e9a06">&#39;root:123456&#39;</span> <span style="color:#000;font-weight:bold">|</span>chpasswd<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span>     useradd runoob<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span>     /bin/echo <span style="color:#4e9a06">&#39;runoob:123456&#39;</span> <span style="color:#000;font-weight:bold">|</span>chpasswd<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span>     /bin/echo -e <span style="color:#4e9a06">&#34;LANG=\&#34;en_US.UTF-8\&#34;&#34;</span> &gt;/etc/default/local<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">EXPOSE</span><span style="color:#4e9a06">  22</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">EXPOSE</span><span style="color:#4e9a06">  80</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">CMD</span>     /usr/sbin/sshd -D<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># 编译创建镜像</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span>docker build -t runoob/centos:6.7 .<span style="color:#a40000">
</span></span></span></code></pre></div><blockquote>
<p>每一个指令的前缀都必须是大写的。</p>
<p><code>RUN</code> 指令告诉docker 在镜像内执行命令，安装了什么</p>
</blockquote>
<p>参数说明：</p>
<ul>
<li><strong><code>-t</code></strong> ：指定要创建的目标镜像名</li>
<li><strong><code>.</code></strong> ：Dockerfile 文件所在目录，可以指定Dockerfile 的绝对路径</li>
</ul>
<h5 id="设置镜像标签">设置镜像标签</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker tag <span style="color:#ce5c00;font-weight:bold">[</span>IMAGE ID<span style="color:#ce5c00;font-weight:bold">]</span> runoob/centos:dev
</span></span></code></pre></div><blockquote>
<p><code>runoob/centos:dev</code></p>
<p>用户名称<code>/</code>镜像源名(repository name)<code>:</code>新的标签名(tag)</p>
</blockquote>
<h4 id="删除镜像">删除镜像</h4>
<pre tabindex="0"><code>docker rmi [IMAGE ID]
</code></pre><h3 id="容器">容器</h3>
<h4 id="启动容器">启动容器</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 交互模式</span>
</span></span><span style="display:flex;"><span>docker run -it <span style="color:#ce5c00;font-weight:bold">[</span>指定运行的镜像<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>启动容器执行的命令<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 进程模式</span>
</span></span><span style="display:flex;"><span>docker run -d <span style="color:#ce5c00;font-weight:bold">[</span>指定运行的镜像<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>启动容器执行的命令<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run -itd --name ubuntu-test ubuntu /bin/bash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 不指定一个镜像的版本标签,默认使用ubuntu:latest镜像</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动已停止的容器</span>
</span></span><span style="display:flex;"><span>docker start <span style="color:#ce5c00;font-weight:bold">[</span>CONTAINER ID<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h4 id="进入容器">进入容器</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果从这个容器退出，会导致容器的停止</span>
</span></span><span style="display:flex;"><span>docker attach
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 会退出容器终端，但不会导致容器的停止</span>
</span></span><span style="display:flex;"><span>docker <span style="color:#204a87">exec</span>
</span></span></code></pre></div><h4 id="停止容器">停止容器</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker stop <span style="color:#ce5c00;font-weight:bold">[</span>CONTAINER ID<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重启容器</span>
</span></span><span style="display:flex;"><span>docker restart <span style="color:#ce5c00;font-weight:bold">[</span>CONTAINER ID<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h4 id="导出容器和导入容器">导出容器和导入容器</h4>
<h5 id="导出容器">导出容器</h5>
<blockquote>
<p>导出容器快照</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker <span style="color:#204a87">export</span> <span style="color:#ce5c00;font-weight:bold">[</span>CONTAINER ID<span style="color:#ce5c00;font-weight:bold">]</span> &gt; <span style="color:#ce5c00;font-weight:bold">[</span>容器快照名<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>docker <span style="color:#204a87">export</span> 1e560fca3906 &gt; ubuntu.tar
</span></span></code></pre></div><h5 id="导入容器">导入容器</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker import <span style="color:#ce5c00;font-weight:bold">[</span>容器快照名<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>docker import http://example.com/exampleimage.tgz example/imagerepo
</span></span></code></pre></div><h4 id="删除容器">删除容器</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker rm -f <span style="color:#ce5c00;font-weight:bold">[</span>CONTAINER ID<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 清理掉所有处于终止状态的容器</span>
</span></span><span style="display:flex;"><span>docker container prune
</span></span></code></pre></div><h4 id="运行web项目">运行web项目</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker pull training/webapp  <span style="color:#8f5902;font-style:italic"># 载入镜像</span>
</span></span><span style="display:flex;"><span>docker run -d -P training/webapp python app.py
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -p设置端口</span>
</span></span><span style="display:flex;"><span>docker run -d -p 5000:5000 training/webapp python app.py
</span></span></code></pre></div><p>参数说明:</p>
<ul>
<li>**<code>-d</code>:**让容器在后台运行。</li>
<li>**<code>-P</code>:**将容器内部使用的网络端口随机映射到我们使用的主机上。</li>
</ul>
<h5 id="查看端口">查看端口</h5>
<blockquote>
<p>查看指定 （ID 或者名字）容器的某个确定端口映射到宿主机的端口号。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker port <span style="color:#ce5c00;font-weight:bold">[</span>CONTAINER ID<span style="color:#ce5c00;font-weight:bold">]</span>/<span style="color:#ce5c00;font-weight:bold">[</span>NAMES<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h5 id="查看-web-应用程序日志">查看 WEB 应用程序日志</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker logs -f <span style="color:#ce5c00;font-weight:bold">[</span>CONTAINER ID<span style="color:#ce5c00;font-weight:bold">]</span>/<span style="color:#ce5c00;font-weight:bold">[</span>NAMES<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p><strong><code>-f</code>:</strong> 让 <strong>docker logs</strong> 像使用 <strong>tail -f</strong> 一样来输出容器内部的标准输出。</p>
<h5 id="查看web应用程序容器的进程">查看WEB应用程序容器的进程</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker top <span style="color:#ce5c00;font-weight:bold">[</span>CONTAINER ID<span style="color:#ce5c00;font-weight:bold">]</span>/<span style="color:#ce5c00;font-weight:bold">[</span>NAMES<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h5 id="检查-web-应用程序">检查 WEB 应用程序</h5>
<blockquote>
<p><strong><code>docker inspect</code></strong>：查看 Docker 的底层信息。它会返回一个 JSON 文件记录着 Docker 容器的配置和状态信息。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker inspect <span style="color:#ce5c00;font-weight:bold">[</span>CONTAINER ID<span style="color:#ce5c00;font-weight:bold">]</span>/<span style="color:#ce5c00;font-weight:bold">[</span>NAMES<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h5 id="移除web应用容器">移除WEB应用容器</h5>
<blockquote>
<p>删除容器时，容器必须是停止状态</p>
</blockquote>
<pre tabindex="0"><code>docker rm [CONTAINER ID]/[NAMES]
</code></pre><h4 id="查询最后一次创建的容器">查询最后一次创建的容器</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker ps -l
</span></span></code></pre></div><h4 id="连接docker容器">连接Docker容器</h4>
<blockquote>
<p>指定容器绑定的网络地址，比如绑定 127.0.0.1</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以通过访问 127.0.0.1:5001 来访问容器的 5000 端口</span>
</span></span><span style="display:flex;"><span>docker run -d -p 127.0.0.1:5001:5000 training/webapp python app.py
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 绑定 UDP 端口(默认TCP)</span>
</span></span><span style="display:flex;"><span>docker run -d -p 127.0.0.1:5000:5000/udp training/webapp python app.py
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看端口的绑定情况</span>
</span></span><span style="display:flex;"><span>docker port adoring_stonebraker <span style="color:#0000cf;font-weight:bold">5000</span>
</span></span></code></pre></div><p>使用 <strong>-p</strong> 标识来指定容器端口绑定到主机端口。</p>
<p>两种方式的区别是:</p>
<ul>
<li><strong><code>-P</code> :<strong>是容器内部端口</strong>随机</strong>映射到主机的端口。</li>
<li><strong><code>-p</code> :</strong> 是容器内部端口绑定到<strong>指定</strong>的主机端口。</li>
</ul>
<h4 id="互联docker-容器">互联Docker 容器</h4>
<blockquote>
<p>端口映射并不是唯一把 docker 连接到另一个容器的方法。</p>
<p>docker 有一个连接系统允许将多个容器连接在一起，共享连接信息。</p>
<p>docker 连接会创建一个父子关系，其中父容器可以看到子容器的信息。</p>
</blockquote>
<h5 id="容器命名">容器命名</h5>
<blockquote>
<p>当我们创建一个容器的时候，docker 会自动对它进行命名。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当我们创建一个容器的时候，docker 会自动对它进行命名</span>
</span></span><span style="display:flex;"><span>docker run -d -P --name <span style="color:#ce5c00;font-weight:bold">[</span>指定名称<span style="color:#ce5c00;font-weight:bold">]</span> 
</span></span></code></pre></div><h5 id="新建网络">新建网络</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建一个新的 Docker 网络</span>
</span></span><span style="display:flex;"><span>docker network create -d bridge test-net
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看docker网络</span>
</span></span><span style="display:flex;"><span>docker network ls
</span></span></code></pre></div><p>参数说明：</p>
<p><strong><code>-d</code></strong>：参数指定 Docker 网络类型，有 bridge、overlay。</p>
<p>​			其中 overlay 网络类型用于 Swarm mode</p>
<h5 id="连接容器">连接容器</h5>
<blockquote>
<p>运行一个容器并连接到新建的 test-net 网络</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run -itd --name test1 --network test-net ubuntu /bin/bash
</span></span></code></pre></div><blockquote>
<p>打开新的终端，再运行一个容器并加入到 test-net 网络</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run -itd --name test2 --network test-net ubuntu /bin/bash
</span></span></code></pre></div><blockquote>
<p>安装ping</p>
<p>可以在一个容器里安装好，提交容器到镜像，在以新的镜像重新运行以上俩个容器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker commit -m<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;说明&#34;</span> -a<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;作者&#34;</span> <span style="color:#ce5c00;font-weight:bold">[</span>CONTAINER ID<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>NAMES<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div></blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt install iputils-ping
</span></span></code></pre></div><h5 id="配置dns">配置DNS</h5>
<blockquote>
<p>在主机上 <code>/etc/docker/daemon.json</code> 设置全部容器的 DNS</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;dns&#34;</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;114.114.114.114&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;8.8.8.8&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><blockquote>
<p>设置后，启动容器的 DNS 会自动配置为 114.114.114.114 和 8.8.8.8。</p>
<p>配置完，需要重启 docker 才能生效。</p>
<p>查看容器的 DNS 是否生效可以使用以下命令，它会输出容器的 DNS 信息：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run -it --rm  ubuntu  cat etc/resolv.conf
</span></span></code></pre></div><h5 id="手动指定容器的配置">手动指定容器的配置</h5>
<blockquote>
<p>如果只想在指定的容器设置 DNS</p>
<p>如果在容器启动时没有指定 <strong>&ndash;dns</strong> 和 <strong>&ndash;dns-search</strong>，Docker 会默认用宿主主机上的 /etc/resolv.conf 来配置容器的 DNS。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run -it --rm -h host_ubuntu  --dns<span style="color:#ce5c00;font-weight:bold">=</span>114.114.114.114 --dns-search<span style="color:#ce5c00;font-weight:bold">=</span>test.com ubuntu
</span></span></code></pre></div><p>参数说明：</p>
<ul>
<li><strong><code>--rm</code></strong>：容器退出时自动清理容器内部的文件系统。</li>
<li><strong><code>-h HOSTNAME</code> 或者 <code>--hostname=HOSTNAME</code></strong>： 设定容器的主机名，它会被写到容器内的 /etc/hostname 和 /etc/hosts。</li>
<li><strong><code>--dns=IP_ADDRESS</code></strong>： 添加 DNS 服务器到容器的 <code>/etc/resolv.conf</code> 中，让容器用这个服务器来解析所有不在 <code>/etc/hosts</code> 中的主机名。</li>
<li><strong><code>--dns-search=DOMAIN</code></strong>： 设定容器的搜索域，当设定搜索域为 .example.com 时，在搜索一个名为 host 的主机时，DNS 不仅搜索 host，还会搜索 host.example.com</li>
</ul>
<h4 id="docker-仓库管理">Docker 仓库管理</h4>
<blockquote>
<p>仓库（Repository）是集中存放镜像的地方</p>
<p><a href="https://hub.docker.com/">Docker Hub</a></p>
</blockquote>
<h5 id="注册">注册</h5>
<blockquote>
<p>在 <a href="https://hub.docker.com/">https://hub.docker.com</a> 免费注册一个 Docker 账号。</p>
</blockquote>
<h5 id="登录">登录</h5>
<blockquote>
<p>登录需要输入用户名和密码，登录成功后，我们就可以从 <code>docker hub</code> 上拉取<strong>自己账号下的全部镜像</strong>。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker login
</span></span></code></pre></div><h5 id="退出"><strong>退出</strong></h5>
<blockquote>
<p>退出 docker hub 可以使用以下命令：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker <span style="color:#204a87">logout</span>
</span></span></code></pre></div><h5 id="拉取镜像">拉取镜像</h5>
<p>你可以通过 <code>docker search</code> 命令来查找<strong>官方仓库中的镜像</strong>，并利用 docker pull 命令来将它下载到本地。</p>
<p>以 ubuntu 为关键词进行搜索：</p>
<pre tabindex="0"><code>docker search ubuntu
docker pull ubuntu 
</code></pre><h5 id="推送镜像">推送镜像</h5>
<blockquote>
<p>用户登录后，可以通过 docker push 命令将自己的镜像推送到 Docker Hub。</p>
<p>以下命令中的 username 请替换为你的 Docker 账号用户名。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker tag ubuntu:18.04 username/ubuntu:18.04
</span></span><span style="display:flex;"><span>docker image ls
</span></span></code></pre></div><h3 id="docker-dockerfile">Docker Dockerfile</h3>
<blockquote>
<p>Dockerfile 是一个用来构建镜像的文本文件，文本内容包含了一条条构建镜像所需的指令和说明。</p>
</blockquote>
<h4 id="定制nginx-镜像">定制nginx 镜像</h4>
<blockquote>
<p><strong>构建好的镜像内会有一个 <code>/usr/share/nginx/html/index.html</code> 文件</strong></p>
<p>空目录下，新建一个名为 Dockerfile 文件</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir Dockerfile
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> Dockerfile/
</span></span><span style="display:flex;"><span>vi Dockerfile
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 打印文件文本</span>
</span></span><span style="display:flex;"><span>cat Dockerfile
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> nginx</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;这是一个本地构建的nginx镜像&#39;</span> &gt; /usr/share/nginx/html/index.html<span style="color:#a40000">
</span></span></span></code></pre></div><ul>
<li>
<p><strong><code>FROM</code></strong>：定制的镜像都是基于 FROM 的镜像，这里的 nginx 就是定制需要的基础镜像。后续的操作都是基于 nginx。</p>
</li>
<li>
<p><strong><code>RUN</code></strong>：用于执行后面跟着的命令行命令。有以下俩种格式：</p>
</li>
</ul>
<p><code>shell</code> 格式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">RUN</span> &lt;命令行命令&gt;<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># &lt;命令行命令&gt; 等同于，在终端操作的 shell 命令。</span><span style="color:#a40000">
</span></span></span></code></pre></div><p><code>exec</code> 格式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">RUN</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;可执行文件&#34;</span>, <span style="color:#4e9a06">&#34;参数1&#34;</span>, <span style="color:#4e9a06">&#34;参数2&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># 例如：</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902;font-style:italic"># RUN [&#34;./test.php&#34;, &#34;dev&#34;, &#34;offline&#34;] 等价于 RUN ./test.php dev offline</span><span style="color:#a40000">
</span></span></span></code></pre></div><blockquote>
<p><strong>注意</strong>：Dockerfile 的指令每执行一次都会在 docker 上新建一层。所以过多无意义的层，会造成镜像膨胀过大。例如：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> centos</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> yum -y install wget<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> wget -O redis.tar.gz <span style="color:#4e9a06">&#34;http://download.redis.io/releases/redis-5.0.3.tar.gz&#34;</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> tar -xvf redis.tar.gz<span style="color:#a40000">
</span></span></span></code></pre></div><p>以上执行会创建 3 层镜像。可简化为以下格式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> centos</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> yum -y install wget <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> wget -O redis.tar.gz <span style="color:#4e9a06">&#34;http://download.redis.io/releases/redis-5.0.3.tar.gz&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> tar -xvf redis.tar.gz<span style="color:#a40000">
</span></span></span></code></pre></div><p>如上，以 <strong>&amp;&amp;</strong> 符号连接命令，这样执行后，<strong>只会创建 1 层镜像</strong>。</p>
<h4 id="开始构建镜像">开始构建镜像</h4>
<blockquote>
<p>在 Dockerfile 文件的存放目录下，执行构建动作。</p>
<p>以下示例，通过目录下的 Dockerfile 构建一个 <code>nginx:v3</code>（镜像名称:镜像标签）。</p>
<p><strong>注</strong>：最后的 <code>.</code> 代表本次执行的上下文路径</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker build -t nginx:v3 .
</span></span><span style="display:flex;"><span>docker images
</span></span></code></pre></div><h5 id="上下文路径">上下文路径</h5>
<blockquote>
<p>上下文路径，是指 docker 在构建镜像，有时候想要使用到本机的文件（比如复制），<code>docker build</code> 命令得知这个路径后，<strong>会将路径下的所有内容打包</strong>。</p>
<p><strong>解析</strong>：由于 docker 的运行模式是 C/S。我们本机是 C，docker 引擎是 S。实际的构建过程是在 docker 引擎下完成的，所以这个时候<strong>无法用到我们本机的文件</strong>。这就需要把我们<strong>本机的指定目录下的文件</strong>一起打包提供给 docker 引擎使用。</p>
<p><strong>如果未说明最后一个参数</strong>，那么默认上下文路径就是 <strong>Dockerfile 所在的位置</strong>。</p>
<p><strong>注意</strong>：上下文路径下不要放无用的文件，因为会一起打包发送给 docker 引擎，如果文件过多会造成过程缓慢。</p>
</blockquote>
<h4 id="指令详解">指令详解</h4>
<blockquote>
<p><a href="https://www.runoob.com/docker/docker-dockerfile.html">Docker Dockerfile | 菜鸟教程 (runoob.com)</a></p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">Dockerfile 指令</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">FROM</td>
<td style="text-align:left">指定<strong>基础镜像</strong>，用于后续的指令构建。</td>
</tr>
<tr>
<td style="text-align:left">MAINTAINER</td>
<td style="text-align:left">指定Dockerfile的作者/维护者。（已弃用，推荐使用<code>LABEL</code>指令）</td>
</tr>
<tr>
<td style="text-align:left">LABEL</td>
<td style="text-align:left">添加镜像的元数据，使用键值对的形式。</td>
</tr>
<tr>
<td style="text-align:left">RUN</td>
<td style="text-align:left">在构建过程中在镜像中执行命令。</td>
</tr>
<tr>
<td style="text-align:left">CMD</td>
<td style="text-align:left">指定容器创建时的默认命令。（可以被覆盖）</td>
</tr>
<tr>
<td style="text-align:left">ENTRYPOINT</td>
<td style="text-align:left">设置容器创建时的主要命令。（不可被覆盖）</td>
</tr>
<tr>
<td style="text-align:left">EXPOSE</td>
<td style="text-align:left">声明容器运行时监听的特定网络端口。</td>
</tr>
<tr>
<td style="text-align:left">ENV</td>
<td style="text-align:left">在容器内部设置环境变量。</td>
</tr>
<tr>
<td style="text-align:left">ADD</td>
<td style="text-align:left">将文件、目录或远程URL复制到镜像中。</td>
</tr>
<tr>
<td style="text-align:left">COPY</td>
<td style="text-align:left">将文件或目录复制到镜像中。</td>
</tr>
<tr>
<td style="text-align:left">VOLUME</td>
<td style="text-align:left">为容器创建挂载点或声明卷。</td>
</tr>
<tr>
<td style="text-align:left">WORKDIR</td>
<td style="text-align:left">设置后续指令的工作目录。</td>
</tr>
<tr>
<td style="text-align:left">USER</td>
<td style="text-align:left">指定后续指令的用户上下文。</td>
</tr>
<tr>
<td style="text-align:left">ARG</td>
<td style="text-align:left">定义在构建过程中传递给构建器的变量，可使用 &ldquo;docker build&rdquo; 命令设置。</td>
</tr>
<tr>
<td style="text-align:left">ONBUILD</td>
<td style="text-align:left">当该镜像被用作另一个构建过程的基础时，添加触发器。</td>
</tr>
<tr>
<td style="text-align:left">STOPSIGNAL</td>
<td style="text-align:left">设置发送给容器以退出的系统调用信号。</td>
</tr>
<tr>
<td style="text-align:left">HEALTHCHECK</td>
<td style="text-align:left">定义周期性检查容器健康状态的命令。</td>
</tr>
<tr>
<td style="text-align:left">SHELL</td>
<td style="text-align:left">覆盖Docker中默认的shell，用于RUN、CMD和ENTRYPOINT指令。</td>
</tr>
</tbody>
</table>
<h3 id="docker-客户端的所有命令选项">Docker 客户端的所有命令选项</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定命令的具体用法</span>
</span></span><span style="display:flex;"><span>docker <span style="color:#ce5c00;font-weight:bold">[</span>command<span style="color:#ce5c00;font-weight:bold">]</span> --help
</span></span></code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-74077482854f1f5386479a36e54652ad">Hugo</h1>
	
	<div class="td-byline mb-4">
		
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-62ba6622c15ab3327cd760e146b1eb0a">准备</h1>
	
	<div class="td-byline mb-4">
		作者: <b>XW</b> |
        
		<time datetime="2023-07-06" class="text-muted">2023-7-6 16:40:29 周一 下午</time>
        
	</div>
	<blockquote>
<p>系统环境：Windows 11 64位</p>
</blockquote>
<p>1.下载Hugo：<a href="https://github.com/gohugoio/hugo/releases">Hugo Releases </a>，并解压</p>
<p>2.添加环境变量</p>
<blockquote>
<ul>
<li>
<p>在<code>设置-系统-系统信息-高级系统设置-环境变量-系统变量-Path</code>添加解压的文件夹目录地址</p>
</li>
<li>
<p>或直接搜索<code>编辑系统环境变量</code> ，在 <code>环境变量-系统变量-Path</code>添加解压的文件夹目录地址</p>
</li>
</ul>
</blockquote>
<p>3.<code>Win+R</code>打开运行输入<code>cmd</code>打开命令指令行，输入</p>
<pre tabindex="0"><code>hugo version
</code></pre><p>检查全局变量是否生效，返回以下内容说明hugo安装成功</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>hugo v0.115.1-857374e69358f788bd31ddc55255c5c8e3dcfd80+extended windows/amd64 <span style="color:#000">BuildDate</span><span style="color:#ce5c00;font-weight:bold">=</span>2023-07-03T17:28:25Z <span style="color:#000">VendorInfo</span><span style="color:#ce5c00;font-weight:bold">=</span>gohugoio
</span></span></code></pre></div><p>4.使用hugo新建一个博客，在命令行输入</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 两种配置文件格式</span>
</span></span><span style="display:flex;"><span>hugo new site blog			<span style="color:#8f5902;font-style:italic"># toml格式</span>
</span></span><span style="display:flex;"><span>hugo new site blog -f yml	<span style="color:#8f5902;font-style:italic"># yml格式</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 生成的目录结构</span>
</span></span><span style="display:flex;"><span>├─assets			资源目录
</span></span><span style="display:flex;"><span>├─content			内容目录<span style="color:#ce5c00;font-weight:bold">(</span>存放.md文件<span style="color:#ce5c00;font-weight:bold">)</span> 就是要发布的文章
</span></span><span style="display:flex;"><span>├─data				数据目录
</span></span><span style="display:flex;"><span>├─layouts			网站模版目录
</span></span><span style="display:flex;"><span>├─public			存放生成的站点文件
</span></span><span style="display:flex;"><span>├─static			静态文件目录<span style="color:#ce5c00;font-weight:bold">(</span>JS、CSS、图片<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>├─themes			主题目录
</span></span><span style="display:flex;"><span>├─archetypes		<span style="color:#ce5c00;font-weight:bold">(</span>存放.md文件的模板<span style="color:#ce5c00;font-weight:bold">)</span> 就是生成文章时用到前言模板
</span></span><span style="display:flex;"><span>│      default.md  	内容模版
</span></span><span style="display:flex;"><span>└─config.toml		配置文件
</span></span></code></pre></div><p>5.启动服务器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#204a87">cd</span> blog
</span></span><span style="display:flex;"><span>hugo server
</span></span></code></pre></div><p>在浏览器输入<code>http://localhost:1313/</code>打开网站</p>
<p>显示<code>Page Not Found</code>说明网站搭建成功</p>
<p>6.安装主题</p>
<p><a href="https://themes.gohugo.io/">Hugo Themes</a></p>
<p>使用的主题模板：<a href="https://github.com/google/docsy">docsy</a></p>
<p>用<code>git</code>将项目克隆到<code>themes</code>文件夹里面</p>
<p><a href="https://github.com/google/docsy-example">docsy-example</a></p>
<h2 id="including-images">Including images</h2>
<p>Here&rsquo;s an image (<code>hugo.jpg</code>) that includes a byline and a caption.</p>
<figure class="card rounded p-2 td-post-card mb-4 mt-4" style="max-width: 610px">
<img class="card-img-top" src="/blog/2023/07/06/%E5%87%86%E5%A4%87/hugo_hu8adc7483941f90761bb921153696661c_76584_600x300_fill_q75_catmullrom_smart1.jpg" width="600" height="300">
<figcaption class="card-body px-0 pt-2 pb-0">
<p class="card-text">


Fetch and scale an image in the upcoming Hugo 0.43.
<small class="text-muted"><br/>Photo: 你好</small>
</p>
</figcaption>
</figure>

<p>The front matter of this post specifies properties to be assigned to all image resources:</p>
<pre tabindex="0"><code>resources:
- src: &#34;**.{png,jpg}&#34;
  title: &#34;Image #:counter&#34;
  params:
    byline: &#34;Photo: Riona MacNamara / CC-BY-CA&#34;
</code></pre><p>To include the image in a page, specify its details like this:</p>
<pre tabindex="0"><code><figure class="card rounded p-2 td-post-card mb-4 mt-4" style="max-width: 610px">
<img class="card-img-top" src="/blog/2023/07/06/%E5%87%86%E5%A4%87/hugo_hu8adc7483941f90761bb921153696661c_76584_600x300_fill_q75_catmullrom_smart1.jpg" width="600" height="300">
<figcaption class="card-body px-0 pt-2 pb-0">
<p class="card-text">


Fetch and scale an image in the upcoming Hugo 0.43.
<small class="text-muted"><br/>Photo: 你好</small>
</p>
</figcaption>
</figure>

</code></pre><p>The image will be rendered at the size and byline specified in the front matter.</p>

</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-be19b65969eca584d90beb10964cea5d">Redis</h1>
	
	<div class="td-byline mb-4">
		作者: <b>XW</b> |
        
	</div>
	<h1 id="redis">Redis</h1>
<blockquote>
<p><a href="https://www.runoob.com/redis/redis-tutorial.html">Redis 教程 | 菜鸟教程 (runoob.com)</a></p>
</blockquote>
<h2 id="简介">简介</h2>
<blockquote>
<p><em>REmote DIctionary Server(Redis) 是一个由 Salvatore Sanfilippo 写的 <strong>key-value</strong> 存储系统，是跨平台的<strong>非关系型数据库</strong>。</em></p>
<p>Redis 是一个开源的使用 ANSI <strong>C 语言</strong>编写、遵守 BSD 协议、支持网络、可<strong>基于内存</strong>、分布式、可选持久性的<strong>键值对(Key-Value)存储数据库</strong>，并提供多种语言的 API。</p>
<p>Redis 通常被称为<strong>数据结构服务器</strong>，因为值（value）可以是字符串(String)、哈希(Hash)、列表(list)、集合(sets)和有序集合(sorted sets)等类型。</p>
</blockquote>
<p>基本数据结构：</p>
<ul>
<li>
<p>String: 字符串</p>
</li>
<li>
<p>Hash: 哈希</p>
<p>key:{</p>
<p>​	key:value</p>
<p>}</p>
</li>
<li>
<p>List: 列表</p>
</li>
<li>
<p>Set: 集合</p>
</li>
<li>
<p>Sorted Set: 有序集合</p>
</li>
</ul>
<p>Redis 与其他 key - value <strong>缓存产品</strong>有以下三个<strong>特点</strong>：</p>
<ul>
<li>Redis支持<strong>数据的持久化</strong>，可以将内存中的数据保存在<strong>磁盘</strong>中，重启的时候可以再次加载进行使用。</li>
<li>Redis不仅仅支持<strong>简单的key-value类型</strong>的数据，同时还提供<code>list，set，zset，hash</code>等数据结构的存储。</li>
<li>Redis支持<strong>数据的备份</strong>，即<code>master-slave</code>模式的数据备份。</li>
</ul>
<h2 id="redis-优势">Redis 优势</h2>
<ul>
<li>性能极高 – Redis能读的速度是110000次/s,写的速度是81000次/s 。</li>
<li>丰富的数据类型 – Redis支持二进制案例的 <code>Strings, Lists, Hashes, Sets 及 Ordered Sets</code> 数据类型操作。</li>
<li><strong>原子</strong> – Redis的所有操作都是原子性的，意思就是要么成功执行要么失败完全不执行。单个操作是原子性的。多个操作也支持事务，即原子性，通过MULTI和EXEC指令包起来。</li>
<li>丰富的特性 – Redis还支持 <strong>publish/subscribe, 通知, key 过期</strong>等等特性。</li>
</ul>
<h2 id="redis安装">Redis安装</h2>
<blockquote>
<p><strong>下载地址：</strong><a href="https://github.com/tporadowski/redis/releases">Releases · tporadowski/redis (github.com)</a></p>
</blockquote>
<ol>
<li>下载解压</li>
<li>配置环境变量</li>
<li>cmd命令行下：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启用默认配置文件</span>
</span></span><span style="display:flex;"><span>redis-server.exe
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定配置文件</span>
</span></span><span style="display:flex;"><span>redis-server.exe redis.windows.conf
</span></span></code></pre></div><p>切换到 redis 目录下运行:</p>
<pre tabindex="0"><code># 连接数据库
redis-cli.exe -h 127.0.0.1 -p 6379
</code></pre><p>设置键值对:</p>
<pre tabindex="0"><code>set myKey myValue
</code></pre><p>取出键值对:</p>
<pre tabindex="0"><code>get myKey
</code></pre><h2 id="redis配置">Redis配置</h2>
<blockquote>
<p>配置文件名为 <strong><code>redis.conf</code></strong>(Windows 名为 <strong><code>redis.windows.conf</code></strong>)</p>
</blockquote>
<h3 id="查看或设置配置项">查看或设置配置项</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># CONFIG命令格式</span>
</span></span><span style="display:flex;"><span>redis 127.0.0.1:6379&gt; CONFIG GET <span style="color:#ce5c00;font-weight:bold">[</span>CONFIG_SETTING_NAME<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取所有配置项</span>
</span></span><span style="display:flex;"><span>redis 127.0.0.1:6379&gt; CONFIG GET *
</span></span></code></pre></div><h3 id="编辑配置项">编辑配置项</h3>
<blockquote>
<p>修改配置文件 <strong><code>redis.conf</code></strong>(Windows 名为 <strong><code>redis.windows.conf</code></strong>)</p>
</blockquote>
<p>使用<strong>CONFIG set</strong> 命令修改配置:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SHELL" data-lang="SHELL"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># CONFIG SET命令格式</span>
</span></span><span style="display:flex;"><span>redis 127.0.0.1:6379&gt; CONFIG SET <span style="color:#ce5c00;font-weight:bold">[</span>CONFIG_SETTING_NAME<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>NEW_CONFIG_VALUE<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>redis 127.0.0.1:6379&gt; CONFIG SET loglevel <span style="color:#4e9a06">&#34;notice&#34;</span>
</span></span></code></pre></div><h3 id="配置文件参数说明">配置文件参数说明</h3>
<p><code>redis.conf</code> 配置项说明如下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">序号</th>
<th style="text-align:left">配置项</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left"><code>daemonize no</code></td>
<td style="text-align:left">Redis <strong>默认</strong>不是以守护进程的方式运行，可以通过该配置项修改，使用 <code>yes</code> <strong>启用守护进程</strong>（Windows <strong>不支持</strong>守护线程的配置为 no ）</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left"><code>pidfile /var/run/redis.pid</code></td>
<td style="text-align:left">当 Redis 以守护进程方式运行时，Redis <strong>默认</strong>会把 <code>pid</code> 写入 <code>/var/run/redis.pid</code> 文件，可以通过 pidfile 指定</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left"><code>port 6379</code></td>
<td style="text-align:left">指定 Redis <strong>监听端口</strong>，默认端口为 <code>6379</code>，作者在自己的一篇博文中解释了为什么选用 6379 作为默认端口，因为 6379 在手机按键上 MERZ 对应的号码，而 MERZ 取自意大利歌女 Alessia Merz 的名字</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left"><code>bind 127.0.0.1</code></td>
<td style="text-align:left">绑定的<strong>主机地址</strong></td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left"><code>timeout 300</code></td>
<td style="text-align:left">当客户端<strong>闲置</strong>多长秒后<strong>关闭连接</strong>，如果指定为 0 ，表示关闭该功能</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:left"><code>loglevel notice</code></td>
<td style="text-align:left">指定<strong>日志记录级别</strong>，Redis 总共支持四个级别：<code>debug</code>、<code>verbose</code>、<code>notice</code>、<code>warning</code>，<strong>默认</strong>为 <code>notice</code></td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left"><code>logfile stdout</code></td>
<td style="text-align:left"><strong>日志记录方式</strong>，<strong>默认</strong>为标准输出，如果配置 Redis 为<strong>守护进程方式运行</strong>，而这里<strong>又配置</strong>为日志记录方式为<strong>标准输出</strong>，则日志将会发送给 <code>/dev/null</code></td>
</tr>
<tr>
<td style="text-align:left">8</td>
<td style="text-align:left"><code>databases 16</code></td>
<td style="text-align:left">设置<strong>数据库的数量</strong>，默认数据库为0，可以使用SELECT 命令在连接上指定数据库<code>id</code></td>
</tr>
<tr>
<td style="text-align:left">9</td>
<td style="text-align:left"><code>save &lt;seconds&gt; &lt;changes&gt;</code><br />Redis 默认配置文件中提供了三个条件：<br /><strong>save 900 1</strong><br /><strong>save 300 10</strong><br /><strong>save 60 10000</strong><br />分别表示 900 秒（15 分钟）内有 1 个更改，300 秒（5 分钟）内有 10 个更改以及 60 秒内有 10000 个更改。</td>
<td style="text-align:left">指定在多长时间内，有多少次更新操作，就将<strong>数据同步</strong>到数据文件，可以多个条件配合</td>
</tr>
<tr>
<td style="text-align:left">10</td>
<td style="text-align:left"><code>rdbcompression yes</code></td>
<td style="text-align:left">指定存储至本地数据库时<strong>是否压缩数据</strong>，默认为 yes，Redis 采用 <code>LZF</code> 压缩，<strong>如果为了节省 CPU 时间，可以关闭该选项，但会导致数据库文件变的巨大</strong></td>
</tr>
<tr>
<td style="text-align:left">11</td>
<td style="text-align:left"><code>dbfilename dump.rdb</code></td>
<td style="text-align:left">指定<strong>本地数据库文件名</strong>，默认值为 <code>dump.rdb</code></td>
</tr>
<tr>
<td style="text-align:left">12</td>
<td style="text-align:left"><code>dir ./</code></td>
<td style="text-align:left">指定本地数据库<strong>存放目录</strong></td>
</tr>
<tr>
<td style="text-align:left">13</td>
<td style="text-align:left"><code>slaveof &lt;masterip&gt; &lt;masterport&gt;</code></td>
<td style="text-align:left">设置当本机为 <code>slave</code> 服务时，设置 <code>master</code> 服务的 IP 地址及端口，在 Redis 启动时，它会自动从 <code>master</code> 进行数据同步</td>
</tr>
<tr>
<td style="text-align:left">14</td>
<td style="text-align:left"><code>masterauth &lt;master-password&gt;</code></td>
<td style="text-align:left">当 master 服务设置了密码保护时，<strong>slave 服务连接 master 的密码</strong></td>
</tr>
<tr>
<td style="text-align:left">15</td>
<td style="text-align:left"><code>requirepass foobared</code></td>
<td style="text-align:left">设置 Redis 连接密码，如果配置了连接密码，客户端在连接 Redis 时需要通过 AUTH <password> 命令提供密码，默认关闭</td>
</tr>
<tr>
<td style="text-align:left">16</td>
<td style="text-align:left"><code> maxclients 128</code></td>
<td style="text-align:left">设置同一时间最大客户端连接数，默认无限制，Redis 可以同时打开的客户端连接数为 Redis 进程可以打开的最大文件描述符数，如果设置 maxclients 0，表示不作限制。当客户端连接数到达限制时，Redis 会关闭新的连接并向客户端返回 max number of clients reached 错误信息</td>
</tr>
<tr>
<td style="text-align:left">17</td>
<td style="text-align:left"><code>maxmemory &lt;bytes&gt;</code></td>
<td style="text-align:left">指定 Redis 最大内存限制，Redis 在启动时会把数据加载到内存中，达到最大内存后，Redis 会先尝试清除已到期或即将到期的 Key，当此方法处理 后，仍然到达最大内存设置，将无法再进行写入操作，但仍然可以进行读取操作。Redis 新的 vm 机制，会把 Key 存放内存，Value 会存放在 swap 区</td>
</tr>
<tr>
<td style="text-align:left">18</td>
<td style="text-align:left"><code>appendonly no</code></td>
<td style="text-align:left">指定是否在每次更新操作后进行日志记录，Redis 在默认情况下是异步的把数据写入磁盘，如果不开启，可能会在断电时导致一段时间内的数据丢失。因为 redis 本身同步数据文件是按上面 save 条件来同步的，所以有的数据会在一段时间内只存在于内存中。默认为 no</td>
</tr>
<tr>
<td style="text-align:left">19</td>
<td style="text-align:left"><code>appendfilename appendonly.aof</code></td>
<td style="text-align:left">指定更新日志文件名，默认为 appendonly.aof</td>
</tr>
<tr>
<td style="text-align:left">20</td>
<td style="text-align:left"><code>appendfsync everysec</code></td>
<td style="text-align:left">指定更新日志条件，共有 3 个可选值：<strong>no</strong>：表示等操作系统进行数据缓存同步到磁盘（快）<strong>always</strong>：表示每次更新操作后手动调用 fsync() 将数据写到磁盘（慢，安全）<strong>everysec</strong>：表示每秒同步一次（折中，默认值）</td>
</tr>
<tr>
<td style="text-align:left">21</td>
<td style="text-align:left"><code>vm-enabled no</code></td>
<td style="text-align:left">指定是否启用虚拟内存机制，默认值为 no，简单的介绍一下，VM 机制将数据分页存放，由 Redis 将访问量较少的页即冷数据 swap 到磁盘上，访问多的页面由磁盘自动换出到内存中（在后面的文章我会仔细分析 Redis 的 VM 机制）</td>
</tr>
<tr>
<td style="text-align:left">22</td>
<td style="text-align:left"><code>vm-swap-file /tmp/redis.swap</code></td>
<td style="text-align:left">虚拟内存文件路径，默认值为 /tmp/redis.swap，不可多个 Redis 实例共享</td>
</tr>
<tr>
<td style="text-align:left">23</td>
<td style="text-align:left"><code>vm-max-memory 0</code></td>
<td style="text-align:left">将所有大于 vm-max-memory 的数据存入虚拟内存，无论 vm-max-memory 设置多小，所有索引数据都是内存存储的(Redis 的索引数据 就是 keys)，也就是说，当 vm-max-memory 设置为 0 的时候，其实是所有 value 都存在于磁盘。默认值为 0</td>
</tr>
<tr>
<td style="text-align:left">24</td>
<td style="text-align:left"><code>vm-page-size 32</code></td>
<td style="text-align:left">Redis swap 文件分成了很多的 page，一个对象可以保存在多个 page 上面，但一个 page 上不能被多个对象共享，vm-page-size 是要根据存储的 数据大小来设定的，作者建议如果存储很多小对象，page 大小最好设置为 32 或者 64bytes；如果存储很大大对象，则可以使用更大的 page，如果不确定，就使用默认值</td>
</tr>
<tr>
<td style="text-align:left">25</td>
<td style="text-align:left"><code>vm-pages 134217728</code></td>
<td style="text-align:left">设置 swap 文件中的 page 数量，由于页表（一种表示页面空闲或使用的 bitmap）是在放在内存中的，，在磁盘上每 8 个 pages 将消耗 1byte 的内存。</td>
</tr>
<tr>
<td style="text-align:left">26</td>
<td style="text-align:left"><code>vm-max-threads 4</code></td>
<td style="text-align:left">设置访问swap文件的线程数,最好不要超过机器的核数,如果设置为0,那么所有对swap文件的操作都是串行的，可能会造成比较长时间的延迟。默认值为4</td>
</tr>
<tr>
<td style="text-align:left">27</td>
<td style="text-align:left"><code>glueoutputbuf yes</code></td>
<td style="text-align:left">设置在向客户端应答时，是否把较小的包合并为一个包发送，默认为开启</td>
</tr>
<tr>
<td style="text-align:left">28</td>
<td style="text-align:left"><code>hash-max-zipmap-entries 64 hash-max-zipmap-value 512</code></td>
<td style="text-align:left">指定在超过一定的数量或者最大的元素超过某一临界值时，采用一种特殊的哈希算法</td>
</tr>
<tr>
<td style="text-align:left">29</td>
<td style="text-align:left"><code>activerehashing yes</code></td>
<td style="text-align:left">指定是否激活重置哈希，默认为开启（后面在介绍 Redis 的哈希算法时具体介绍）</td>
</tr>
<tr>
<td style="text-align:left">30</td>
<td style="text-align:left"><code>include /path/to/local.conf</code></td>
<td style="text-align:left">指定包含其它的配置文件，可以在同一主机上多个Redis实例之间使用同一份配置文件，而同时各个实例又拥有自己的特定配置文件</td>
</tr>
</tbody>
</table>
<h2 id="redis-数据类型">Redis 数据类型</h2>
<blockquote>
<p>Redis支持五种数据类型：<code>string</code>（字符串），<code>hash</code>（哈希），<code>list</code>（列表），<code>set</code>（集合）及<code>zset</code>(<code>sorted set</code>：有序集合)。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> 		<span style="color:#8f5902;font-style:italic">// 字符串、对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">opsForValue</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">set</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#4e9a06">&#34;VALUE&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">String</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">opsForValue</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 列表，后进先出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">ListOperations</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">listOperations</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">opsForList</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 从左边加
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">listOperations</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">leftPush</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#4e9a06">&#34;VALUE&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 从右边加
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">listOperations</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">rightPush</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#4e9a06">&#34;VALUE2&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 取key为&#34;KEY&#34;的值，第0-1的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// 0,-1	 取全部
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">List</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">stringList</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">listOperations</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">range</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 从左边取
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">String</span> <span style="color:#000">leftPop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">listOperations</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">leftPop</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 集合
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">SetOperations</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">setOperations</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">opsForSet</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// value数据唯一
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">setOperations</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#4e9a06">&#34;VALUE&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setOperations</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#4e9a06">&#34;VALUE2&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Set</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">stringSet</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">setOperations</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">members</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 有序集合
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">ZSetOperations</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">zSetOperations</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">opsForZSet</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 有序
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">zSetOperations</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#4e9a06">&#34;VALUE&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">zSetOperations</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#4e9a06">&#34;VALUE2&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">zSetOperations</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#4e9a06">&#34;VALUE3&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 取第0-3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">Set</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">stringSet</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zSetOperations</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">range</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 哈希 （key hashKey value）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// （hashMap的key，hashMap存的key，hashMa存的value）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">HashOperations</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">hashOperations</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">opsForHash</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">hashOperations</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#4e9a06">&#34;HashKey&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#4e9a06">&#34;VALUE&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 先用hashMap的key，拿到hashMap，再用hashMa存的key拿到value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">String</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">hashOperations</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KEY&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#4e9a06">&#34;HashKey&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span></code></pre></div><h2 id="springboot使用redis">SpringBoot使用Redis</h2>
<h3 id="导入依赖">导入依赖</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.apache.commons<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>commons-pool2<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id="实体类">实体类</h3>
<blockquote>
<p>实现序列化接口</p>
</blockquote>
<h3 id="applicationyml"><code>application.yml</code></h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">spring</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">redis</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">localhost</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#8f5902;font-style:italic"># 第0个数据库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">RedisTemplate</span> <span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">// 将key和验证码存入redis
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">opsForValue</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">set</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">verifyKey</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">captcha</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 从Redis拿到正确的验证码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">String</span> <span style="color:#000">captcha</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">opsForValue</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">verifyKey</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span></code></pre></div><h3 id="乱码解决">乱码解决</h3>
<blockquote>
<p>Key:</p>
<p>\xAC\xED\x00\x05t\x00.captcha_codes:ab6ccfafd05d4084b0526e20aceb542a</p>
<p>value:</p>
<p>��</p>
</blockquote>
<p>原因：</p>
<blockquote>
<p><strong>spring-data-redis</strong> 的 <strong>RedisTemplate&lt;K, V&gt;模板类</strong> 在操作redis时默认使用JdkSerializationRedisSerializer 来进行<a href="https://so.csdn.net/so/search?q=%E5%BA%8F%E5%88%97%E5%8C%96&amp;spm=1001.2101.3001.7020">序列化</a>。</p>
<p>spring操作redis是在jedis客户端基础上进行的，而jedis客户端与redis交互的时候协议中定义是用byte类型交互</p>
<p>spring-data-redis中RedisTemplate&lt;K, V&gt;在操作的时候k，v是泛型对象，而不是byte[]类型的</p>
<p>spring会默认采用defaultSerializer = new JdkSerializationRedisSerializer()</p>
<p>JdkSerializationRedisSerializer它使用的编码是ISO-8859-1</p>
</blockquote>
<p>解决：</p>
<ol>
<li>规定redisTemplate的类型(不行)</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@Autowired</span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">RedisTemplate</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">redisTemplate</span>
</span></span></code></pre></div><ol start="2">
<li>添加 redis 配置类，配置使用的序列化方式</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RedisConfig</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Bean</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;redisTemplate&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">RedisTemplate</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Object</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Object</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RedisConnectionFactory</span> <span style="color:#000">factory</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">RedisTemplate</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Object</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Object</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">template</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RedisTemplate</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">RedisSerializer</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">redisSerializer</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">StringRedisSerializer</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">template</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setConnectionFactory</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">factory</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">//key序列化方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">template</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setKeySerializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">redisSerializer</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">//value序列化
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">template</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setValueSerializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">redisSerializer</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">//value hashmap序列化
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">template</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setHashValueSerializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">redisSerializer</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">//key haspmap序列化
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">template</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setHashKeySerializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">redisSerializer</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">template</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><pre tabindex="0"><code>@Configuration
public class RedisConfig {
    @Autowired
    private RedisTemplate redisTemplate;

    @Bean
    public RedisTemplate redisTemplateInit() {
        //设置序列化Key的实例化对象
        redisTemplate.setKeySerializer(new StringRedisSerializer());
        //设置序列化Value的实例化对象
        redisTemplate.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        return redisTemplate;
    }
}
</code></pre><ol start="3">
<li>使用 StringRedisTemplate 而不是使用 RedisTemplate</li>
</ol>
<h3 id="redis配置类">Redis配置类</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">com.zq.vaccinum.config</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.springframework.beans.factory.annotation.Autowired</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.springframework.context.annotation.Bean</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.springframework.context.annotation.Configuration</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.springframework.data.redis.core.RedisTemplate</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.springframework.data.redis.serializer.StringRedisSerializer</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @Author: zq
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @Date: 2023/08/01/21:00
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * @Description:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RedisConfig</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Autowired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">RedisTemplate</span> <span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    * 乱码处理
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    * */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">RedisTemplate</span> <span style="color:#000">redisTemplateInit</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">//设置序列化Key的实例化对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setKeySerializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">StringRedisSerializer</span><span style="color:#ce5c00;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">//设置序列化Value的实例化对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setValueSerializer</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">GenericJackson2JsonRedisSerializer</span><span style="color:#ce5c00;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">redisTemplate</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><blockquote>
<p><a href="https://blog.csdn.net/zwj1030711290/article/details/127695945">Redis之RedisTemplate配置方式(序列和反序列化)（八）_genericfastjsonredisserializer_擦肩而过的博客-CSDN博客</a></p>
</blockquote>
<h2 id="bug">bug</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>org.springframework.data.redis.serializer.SerializationException: Could not <span style="color:#204a87">read</span> JSON: Unrecognized field <span style="color:#4e9a06">&#34;username&#34;</span> <span style="color:#ce5c00;font-weight:bold">(</span>class com.zq.vaccinum.domain.LoginUser<span style="color:#ce5c00;font-weight:bold">)</span>, not marked as ignorable <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span> known properties: <span style="color:#4e9a06">&#34;token&#34;</span>, <span style="color:#4e9a06">&#34;user&#34;</span>, <span style="color:#4e9a06">&#34;authorities&#34;</span><span style="color:#ce5c00;font-weight:bold">])</span>
</span></span></code></pre></div><p>原因：LoginUser类未定义一些属性，反序列化失败</p>
<p>解决：使用注解</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@JsonIgnoreProperties</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ignoreUnknown</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><blockquote>
<p><a href="https://stackoverflow.com/questions/4486787/jackson-with-json-unrecognized-field-not-marked-as-ignorable">https://stackoverflow.com/questions/4486787/jackson-with-json-unrecognized-field-not-marked-as-ignorable</a></p>
</blockquote>

</div>





    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="User mailing list" aria-label="User mailing list">
    <a target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Twitter" aria-label="Twitter">
    <a target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Stack Overflow" aria-label="Stack Overflow">
    <a target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-end text-xs-center order-sm-3">
        
        
        
<ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/x-windy/" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Slack" aria-label="Slack">
    <a target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="Developer mailing list" aria-label="Developer mailing list">
    <a target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2">
        <span>&copy; 2023 XW All Rights Reserved</span>
        
        
      </div>
    </div>
  </div>
  
<link rel="stylesheet" href='/shortcodes/plugins-live2d/css/index.css?v=1.0.1' />
<link rel="stylesheet" href='/shortcodes/plugins-live2d/css/waifu.min.css?v=1.0.1' />

<div class= "plugins-live2d-data" data-live2d_width="200" data-live2d_height="220" data-live2d_position="right:10" data-live2d_minwidth="400px"></div>

<script src='/shortcodes/plugins-live2d/js/index.js?v=1.0.1'></script>

</footer>
    </div>
    
  <script src="/js/main.min.9d4be27dd7b0e6c9b2948920085964b72679202e8e0439382ea6a68173e03576.js" integrity="sha256-nUvifdew5smylIkgCFlktyZ5IC6OBDk4LqamgXPgNXY=" crossorigin="anonymous"></script>
<script defer src="/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>
